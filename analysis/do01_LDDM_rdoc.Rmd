---
title: "Data analysis script 2: Testing for replication of ERP to DDM concordance in RDoC dataset"
author: "Brent Rappaport"
date: "`r format(Sys.time(),  '%Y-%m-%d')`"
output:
  pdf_document: default
  html_document:
    df_print: paged
subtitle: Template Rmd
editor_options:
  chunk_output_type: console
toc: yes
---

# About
This script does preliminary data analysis comparing the psychometrics of HDDM models vs. raw accuracy vs. NIH Toolbox derived score for the Flanker task of the RDoC study.

v = **drift rate**: "The parameter of primary interest for the present study is the drift rate, v, which is the average rate of approach to a boundary and indexes the quality or strength of evidence extracted from the stimulus. A large value of drift indicates strong decision evidence, meaning the decision process will approach the appropriate boundary quickly, leading to fast and accurate responses." Larger values of v mean faster accumulation of evidence (faster rate), larger t means slower non-decision time processing.

z = **response bias**: "If participants were
biased toward one of the two responses (e.g., by increasing the proportion of one response over the other), they would move their starting point closer to that boundary. This produces faster and more probable responses at that boundary since less evidence is needed to reach it." Distance between the the start of the drift process and upper boundary.

a = **separation between the two boundaries**: "response caution or speed/accuracy tradeoffs. If the boundary separation is relatively small, responses will take less time to reach a boundary, leading to faster responses, but they will also be more likely to reach the wrong boundary due to noise in the process, leading to more errors." Larger a means more separation between the correct and incorrect response boundaries

t = **non-decision time**: "takes into account the duration of nondecisional processes...such processes may comprise basic encoding processes, the configuration of working memory for a task, and processes of response execution (i.e., motor activity)." (Voss et al., 2013)

Per Allie, larger values of v mean faster accumulation of evidence (faster rate), larger t means slower non-decision time processing, larger a means more separation between the correct and incorrect response boundaries, and z is the distance from the upper boundary to the start of the drift process.

# Get Setup
## Clear everything & set width
```{r echo=FALSE, results='hide', message=FALSE, warning=FALSE}
    options(width=80, Ncpus = 6) #Set width
    rm(list=ls())     #Remove everything from environment
    cat("\014")       #Clear Console
```

## Load Libraries
```{r echo=FALSE, message=FALSE, warning=FALSE}
  # renv::restore()     #restore environment
  library(knitr)      #allows rmarkdown files
  library(haven)      #helps import stata
  library(MASS)       #calculate residualized scores
  library(tidyverse)  #plotting/cleaning, etc.
  library(broom)      #nice statistical output
  library(here)       #nice file paths
  library(expss)      #labeling variables/values
  library(psych)      #used for statistical analyses
  library(labelled)
  library(confintr)
  library(papaja)
  library(DescTools)
  library(irr)
  library(workflowr)  #helps with workflow
  library(lmerTest)
  library(broom.mixed)
  library(ggplot2)

  here()
  set.seed(312)    #Set seed
```

## Functions
### Correlation_matrix
```{r}
correlation_matrix <- function(df, 
                               type = "pearson",
                               digits = 3, 
                               decimal.mark = ".",
                               use = "all", 
                               show_significance = TRUE, 
                               replace_diagonal = FALSE, 
                               replacement = ""){
  
  # check arguments
  stopifnot({
    is.numeric(digits)
    digits >= 0
    use %in% c("all", "upper", "lower")
    is.logical(replace_diagonal)
    is.logical(show_significance)
    is.character(replacement)
  })
  # we need the Hmisc package for this
  require(Hmisc)
  
  # retain only numeric and boolean columns
  isNumericOrBoolean = vapply(df, function(x) is.numeric(x) | is.logical(x), logical(1))
  if (sum(!isNumericOrBoolean) > 0) {
    cat('Dropping non-numeric/-boolean column(s):', paste(names(isNumericOrBoolean)[!isNumericOrBoolean], collapse = ', '), '\n\n')
  }
  df = df[isNumericOrBoolean]
  
  # transform input data frame to matrix
  x <- as.matrix(df)
  
  # run correlation analysis using Hmisc package
  correlation_matrix <- Hmisc::rcorr(x, type = )
  R <- correlation_matrix$r # Matrix of correlation coeficients
  p <- correlation_matrix$P # Matrix of p-value 
  
  # transform correlations to specific character format
  Rformatted = formatC(R, format = 'f', digits = digits, decimal.mark = decimal.mark)
  
  # if there are any negative numbers, we want to put a space before the positives to align all
  if (sum(R < 0) > 0) {
    Rformatted = ifelse(R > 0, paste0(' ', Rformatted), Rformatted)
  }
  
  # add significance levels if desired
  if (show_significance) {
    # define notions for significance levels; spacing is important.
    stars <- ifelse(is.na(p), "   ", ifelse(p < .001, "***", ifelse(p < .01, "** ", ifelse(p < .05, "*  ", "   "))))
    Rformatted = paste0(Rformatted, stars)
  }
  # build a new matrix that includes the formatted correlations and their significance stars
  Rnew <- matrix(Rformatted, ncol = ncol(x))
  rownames(Rnew) <- colnames(x)
  colnames(Rnew) <- paste(colnames(x), "", sep =" ")
  
  # replace undesired values
  if (use == 'upper') {
    Rnew[lower.tri(Rnew, diag = replace_diagonal)] <- replacement
  } else if (use == 'lower') {
    Rnew[upper.tri(Rnew, diag = replace_diagonal)] <- replacement
  } else if (replace_diagonal) {
    diag(Rnew) <- replacement
  }
  
  return(Rnew)
}

save_correlation_matrix = function(df, filename, ...) {
  write.csv2(correlation_matrix(df, ...), file = filename)
}
```
### Make CIs
```{r}
make_CI <- function(lower, upper) {
  paste0("[", round(lower,2), ", ", round(upper,2), "]")
}
```


## Load Data
Remember to immediately rename and remove. Avoid overwriting old data.
```{r}
here::i_am("./analysis/do01_LDDM_rdoc.Rmd")

# LDDM_do1_alt_rdoc <- read.csv(here("../RDoC/DDM_Results/Block_Based/RDoC_Day1_Block11_Alternative_Models.csv"), header=TRUE)
LDDM_do1_alt1_rdoc <- read.csv(here("./data/RDoC_ERN_acc_B11_avtz_DO_vta_sdvz.csv"), header=TRUE)
# LDDM_do1_alt2_rdoc <- read.csv(here("./data/RDoC_ERN_acc_B11_avt_DO_vta_sdv.csv"), header=TRUE)
# LDDM_do1_alt2_rdoc <- read.csv(here("./data/RDoC_ERN_acc_B11_avt_DO_va_sdv_rev.csv"), header=TRUE)

LDDM_do1_rdoc <- read_sav(here("./data/RDoC_ERN_0-80ms_Final.sav"))
LDDM_do1_rdoc$ID <- LDDM_do1_rdoc$SubjectID

LDDM_do2_rdoc <- LDDM_do1_rdoc %>%
  left_join(LDDM_do1_alt1_rdoc, by="ID") %>%
  # left_join(LDDM_do1_alt2_rdoc, by="ID") %>%
  distinct(ID, .keep_all = TRUE) %>%
  filter(DQ >= 0.5)
  
  
load(file=here("./data/LDDM_cleaning04_fullbeh_rdoc.RData"))

load(file=here("./data/LDDM_cleaning04_rdoc_calc4.RData"))

## Load Color-Word D-KEFS test (Stroop) data
LDDM_do1_rdoc_iq <- read_sav(here("./data/RDoC_WTAR_FINAL 1.28.2019.sav"))
LDDM_do1_rdoc_iq$ID <- LDDM_do1_rdoc_iq$SubjectID
# lapply(LDDM_do1_rdoc_iq, attr, "label")
LDDM_do1_neuro <- read_sav(here("./data/RDoC_Neuropsych_Cleaning_HL_FINAL_3.19.18.sav"))
LDDM_do1_neuro$ID <- LDDM_do1_neuro$SubjectID
# LDDM_do1_education <- read_sav(here("./data/FINAL_RDoC_Proband_Sibling_ALL_Questionnaires_ItemLevel_2.8.19.sav"))
## Load data on participant's gender
LDDM_do3_rdoc_gender <- read_sav(here("./data/FINAL_RDoC_Proband_Sibling_SCID_categoricalDx,10.5.2018.sav"))
LDDM_do3_rdoc_gender$ID <- LDDM_do3_rdoc_gender$SubjectID
LDDM_do3_rdoc_gender$Gender <- LDDM_do3_rdoc_gender$b12
LDDM_do3_rdoc_gender_only <- LDDM_do3_rdoc_gender %>%
  select(ID,Gender)

LDDM_do2_neuro <- LDDM_do1_neuro %>%
  left_join(LDDM_do1_rdoc_iq, by="ID")

LDDM_do3_rdoc <- LDDM_do2_rdoc %>%
  left_join(LDDM_do3_rdoc_gender_only, by="ID") %>%
  left_join(LDDM_cleaning04_rdoc_calc4, by="ID") %>%
  left_join(LDDM_do2_neuro, by="ID") %>%
  select(-starts_with("Reason"))

# LDDM_do3_rdoc_no_outliers <- LDDM_do2_rdoc_no_outliers %>%
  # left_join(LDDM_cleaning04_rdoc_calc4, by="ID")
  # 
```

## Remove subjects with bad data
```{r}
all_rdoc <- read_sav(here("../RDoC/All_Enrolled_IDs.sav"))
all_ern_rdoc<- read_sav(here("../RDoC/RDoC_ERN_0-80ms_Final.sav"))

all_rdoc <- all_rdoc %>%
  mutate(Eligible_use_this = Eligible) %>%
  select(SubjectID, Eligible_use_this, Reason)

all_ern_rdoc <- all_ern_rdoc %>%
  mutate(Has_atleast_10_error_trials = all_ern_rdoc$Number_of_errors_included_in_average>9,
         good_data = all_ern_rdoc$DQ>=0.5 & all_ern_rdoc$DQ<2) %>%
  select(SubjectID, Has_atleast_10_error_trials, good_data)

LDDM_do3_rdoc_with_bad_data <- full_join(LDDM_do3_rdoc, all_rdoc, by="SubjectID") %>%
  left_join(all_ern_rdoc, by="SubjectID")

LDDM_do3_rdoc <- full_join(LDDM_do3_rdoc, all_rdoc, by="SubjectID") %>%
  full_join(all_ern_rdoc, by="SubjectID") %>%
  filter(Eligible_use_this==1) %>%
  filter(Has_atleast_10_error_trials==TRUE) %>%
  filter(good_data==TRUE)
```

## Make residualized score
```{r}
electrodes_list <- c("Fz","Cz","FCz")

# Calculate residualized ERN and difference score ERN (for verification of direction)
for (ex in electrodes_list[1:3]){
    eval(parse(text=paste0('LDDM_do3_rdoc$',ex,'_ERN_080 <- stdres(lm(',ex,'3chan_error_500_300 ~ ',ex, '3chan_correct_500_300, LDDM_do3_rdoc, na.action=na.exclude))')))
    eval(parse(text=paste0('LDDM_do3_rdoc$',ex,'_ERN_080_diff <- LDDM_do3_rdoc$',ex,'3chan_error_500_300 - LDDM_do3_rdoc$',ex,'3chan_correct_500_300')))
    eval(parse(text=paste0('LDDM_do3_rdoc$',ex,'_ERN_080_diff <- as.numeric(LDDM_do3_rdoc$',ex,'_ERN_080_diff)')))
    eval(parse(text=paste0('LDDM_do3_rdoc$',ex,'_ERN_080 <- as.numeric(LDDM_do3_rdoc$',ex,'_ERN_080)')))
}

# LDDM_do3_rdoc$B11_avtz_DO_v_v <- rowMeans(LDDM_do3_rdoc[,c('B11_avtz_DO_v_v_con','B11_avtz_DO_v_v_incon')], na.rm=F)
# LDDM_do3_rdoc$B11_avt_DO_v_v <- rowMeans(LDDM_do3_rdoc[,c('B11_avt_DO_v_v_con','B11_avt_DO_v_v_incon')], na.rm=F)
# LDDM_do3_rdoc$B11_avtz_DO_v_v <- rowMeans(LDDM_do3_rdoc[,c('B11_avtz_DO_v_v_con','B11_avtz_DO_v_v_incon')], na.rm=F)
```

## Reverse score Inhib & Exec
```{r}
LDDM_do3_rdoc$Inhib_time_rev <- -1*LDDM_do3_rdoc$Inhib_time

LDDM_do3_rdoc$exec_composite <- -1*rowMeans(LDDM_do3_rdoc[,c("FF_cor","Switch_cor","NL_time","InSw_time")], na.rm=F)
```

## Remove outliers
```{r}
# lapply(LDDM_do3_rdoc, attr, "label")

LDDM_do3_rdoc_no_outliers <- LDDM_do3_rdoc %>%
  mutate(FCz_ERN_080 = Winsorize(FCz_ERN_080, 
                                    minval=mean(FCz_ERN_080, na.rm=T)-(3*sd(FCz_ERN_080, na.rm=T)),
                                    maxval=mean(FCz_ERN_080, na.rm=T)+(3*sd(FCz_ERN_080, na.rm=T)),
                                    na.rm=T),
         Inhib_time_rev = Winsorize(Inhib_time_rev, 
                                    minval=mean(Inhib_time_rev, na.rm=T)-(3*sd(Inhib_time_rev, na.rm=T)),
                                    maxval=mean(Inhib_time_rev, na.rm=T)+(3*sd(Inhib_time_rev, na.rm=T)),
                                    na.rm=T),
         exec_composite = Winsorize(exec_composite, 
                                    minval=mean(exec_composite, na.rm=T)-(3*sd(exec_composite, na.rm=T)),
                                    maxval=mean(exec_composite, na.rm=T)+(3*sd(exec_composite, na.rm=T)),
                                    na.rm=T)) %>%
  mutate(FCz_ERN_080 = FCz_ERN_080*-1)

# LDDM_do3_rdoc_no_outliers$NL_time_rev <- -1*LDDM_do3_rdoc_no_outliers$NL_time
# LDDM_do3_rdoc_no_outliers$Inhib_time_rev_z <- scale(LDDM_do3_rdoc_no_outliers$Inhib_time_rev, center=T, scale=T)
```

# Variable lists (CHANGE THESE)
```{r}
var_list <- c("v_congruent","v_incongruent","a_congruent","a_incongruent","t_congruent","t_incongruent","z",
              "flanker_score_rdoc","accuracy_incongruent","rt_interference","accuracy","accuracy_congruent_log",
              "FCz_ERN_080","FCz_ERN_080_diff",
              "Inhib_time_rev","exec_composite","Pred_FSIQ","Motor_time")

var_abbreviations <- c("^v_", "^a_", "^t_", "^z")

var_names <- c("Drift rate (congruent)","Drift rate (incongruent)",
                         "Boundary separation (congruent)","Boundary separation (incongruent)",
                         "Non-decision time (congruent)","Non-decision time (incongruent)","Starting bias")

var_list2 <- c("B11_avt_DO_vta_sdv_a_con", "B11_avt_DO_vta_sdv_a_incon", "B11_avt_DO_vta_sdv_v_con", "B11_avt_DO_vta_sdv_v_incon", "B11_avt_DO_vta_sdv_t_con" , "B11_avt_DO_vta_sdv_t_incon")

var_names2 <- c("Drift rate (congruent)","Drift rate (incongruent)",
                         "Boundary separation (congruent)","Boundary separation (incongruent)",
                         "Non-decision time (congruent)","Non-decision time (incongruent)")

var_list_alt <- c("B11_avt_v","B11_avt_a","B11_avt_t",
              "B11_avtz_DO_v_v_con","B11_avtz_DO_v_v_incon","B11_avtz_DO_v_a","B11_avtz_DO_v_t","B11_avtz_DO_v_z",
              # "B11_avtz_DO_vt_v_con","B11_avtz_DO_vt_v_incon","B11_avtz_DO_vt_a", "B11_avtz_DO_vt_t_con","B11_avtz_DO_vt_t_incon","B11_avtz_DO_vt_z",
              # "B11_avtz_DO_vtz_v_con","B11_avtz_DO_vtz_v_incon","B11_avtz_DO_vtz_a","B11_avtz_DO_vtz_t_con","B11_avtz_DO_vtz_t_incon","B11_avtz_DO_vtz_z_con","B11_avtz_DO_vtz_z_incon",
              "FCZ_ERN_080")
```

# Standardize scores
```{r}
for (v in var_list){
  print(paste0("LDDM_do3_rdoc$",v))
  eval(parse(text=paste0('LDDM_do3_rdoc$',v,'_z <- scale(LDDM_do3_rdoc$',v,', center=T, scale=T)'))) 
}

for (v in var_list){ 
  print(paste0("LDDM_do3_rdoc$",v))
  eval(parse(text=paste0('LDDM_do3_rdoc_no_outliers$',v,'_z <- scale(LDDM_do3_rdoc_no_outliers$',v,', center=T, scale=T)'))) 
}
```


#  Multiple regressions
## ERN
### Primary model (DO VTA, Z)
```{r new version, eval=TRUE}
i=1
mr_ERN_table_rdoc <- as.data.frame(matrix(nrow=length(var_names), ncol=5))
mr_ERN_table_rdoc[,1] <- var_names
mr_ERN_table_rdoc_raw <- as.data.frame(matrix(nrow=length(var_names), ncol=13))
mr_ERN_table_rdoc_raw[,1] <- var_names
colnames(mr_ERN_table_rdoc) <- c("Parameters","DDM", "NIH Toolbox", "Raw accuracy", "RT interference")

for (var in paste0(map(var_abbreviations, str_subset, string = var_list) %>% reduce(union),"_z")) {
  eval(parse(text=paste0("
             model <- lmer(FCz_ERN_080_z ~ ",var," + flanker_score_rdoc_z + accuracy_incongruent_z + rt_interference_z + Age + Pred_FSIQ_z + Motor_time_z + (1 | F_ID), LDDM_do3_rdoc_no_outliers)
             
             mr_ERN_table_rdoc[i,2] <- paste0(round(tidy(model)$estimate[2],2), ifelse(tidy(model)$p.value[2]<0.01, '** ', ifelse(tidy(model)$p.value[2]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[4,1], confint(model)[4,2]))
             mr_ERN_table_rdoc[i,3] <- paste0(round(tidy(model)$estimate[3],2), ifelse(tidy(model)$p.value[3]<0.01, '** ', ifelse(tidy(model)$p.value[3]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[5,1], confint(model)[5,2]))
             mr_ERN_table_rdoc[i,4] <- paste0(round(tidy(model)$estimate[4],2), ifelse(tidy(model)$p.value[4]<0.01, '** ', ifelse(tidy(model)$p.value[4]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[6,1], confint(model)[6,2]))
             mr_ERN_table_rdoc[i,5] <- paste0(round(tidy(model)$estimate[5],2), ifelse(tidy(model)$p.value[5]<0.01, '** ', ifelse(tidy(model)$p.value[5]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[7,1], confint(model)[7,2]))

            mr_ERN_table_rdoc_raw[i,2] <- tidy(model)$estimate[2]
            mr_ERN_table_rdoc_raw[i,3] <- confint(model)[4,1]
            mr_ERN_table_rdoc_raw[i,4] <- confint(model)[4,2]

            mr_ERN_table_rdoc_raw[i,5] <- tidy(model)$estimate[3]
            mr_ERN_table_rdoc_raw[i,6] <- confint(model)[5,1]
            mr_ERN_table_rdoc_raw[i,7] <- confint(model)[5,2]

            mr_ERN_table_rdoc_raw[i,8] <- tidy(model)$estimate[4]
            mr_ERN_table_rdoc_raw[i,9] <- confint(model)[6,1]
            mr_ERN_table_rdoc_raw[i,10] <- confint(model)[6,2]

            mr_ERN_table_rdoc_raw[i,11] <- tidy(model)$estimate[5]
            mr_ERN_table_rdoc_raw[i,12] <- confint(model)[7,1]
            mr_ERN_table_rdoc_raw[i,13] <- confint(model)[7,2]
                                   ")))
  i=i+1
}

write.csv(mr_ERN_table_rdoc, here("./tables/mr_ERN_table_rdoc.csv"))
write.csv(mr_ERN_table_rdoc_raw, here("./tables/mr_ERN_table_rdoc_raw.csv"))
```

### Seconday model (DO VTA)
```{r, eval=FALSE}
i=1
mr_ERN_table_rdoc_2 <- as.data.frame(matrix(nrow=length(var_names2), ncol=5))
mr_ERN_table_rdoc_2[,1] <- var_names2
colnames(mr_ERN_table_rdoc_2) <- c("Parameters","DDM", "NIH Toolbox", "Raw accuracy", "RT interference")

for (var in paste0(map(var_abbreviations[1:length(var_abbreviations)-1], str_subset, string = var_list) %>% reduce(union),"_z")) {
  eval(parse(text=paste0("
             model <- lmer(FCz_ERN_080_z ~ ",var," + flanker_score_rdoc_z + accuracy_incongruent_z + rt_interference_z + Age + Pred_FSIQ_z + Motor_time_z + (1 | F_ID), LDDM_do3_rdoc_no_outliers)
             
             mr_ERN_table_rdoc_2[i,2] <- paste0(round(tidy(model)$estimate[2],2), ifelse(tidy(model)$p.value[2]<0.01, '** ', ifelse(tidy(model)$p.value[2]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[4,1], confint(model)[4,2]))
             mr_ERN_table_rdoc_2[i,3] <- paste0(round(tidy(model)$estimate[3],2), ifelse(tidy(model)$p.value[3]<0.01, '** ', ifelse(tidy(model)$p.value[3]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[5,1], confint(model)[5,2]))
             mr_ERN_table_rdoc_2[i,4] <- paste0(round(tidy(model)$estimate[4],2), ifelse(tidy(model)$p.value[4]<0.01, '** ', ifelse(tidy(model)$p.value[4]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[6,1], confint(model)[6,2]))
             mr_ERN_table_rdoc_2[i,5] <- paste0(round(tidy(model)$estimate[5],2), ifelse(tidy(model)$p.value[5]<0.01, '** ', ifelse(tidy(model)$p.value[5]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[7,1], confint(model)[7,2]))

            # mr_ERN_table_rdoc_2_raw[i,2] <- tidy(model)$estimate[2]
            # mr_ERN_table_rdoc_2_raw[i,3] <- confint(model)[4,1]
            # mr_ERN_table_rdoc_2_raw[i,4] <- confint(model)[4,2]
            # 
            # mr_ERN_table_rdoc_2_raw[i,5] <- tidy(model)$estimate[3]
            # mr_ERN_table_rdoc_2_raw[i,6] <- confint(model)[5,1]
            # mr_ERN_table_rdoc_2_raw[i,7] <- confint(model)[5,2]
            # 
            # mr_ERN_table_rdoc_2_raw[i,8] <- tidy(model)$estimate[4]
            # mr_ERN_table_rdoc_2_raw[i,9] <- confint(model)[6,1]
            # mr_ERN_table_rdoc_2_raw[i,10] <- confint(model)[6,2]
            # 
            # mr_ERN_table_rdoc_2_raw[i,11] <- tidy(model)$estimate[5]
            # mr_ERN_table_rdoc_2_raw[i,12] <- confint(model)[7,1]
            # mr_ERN_table_rdoc_2_raw[i,13] <- confint(model)[7,2]
                                   ")))
  i=i+1
}

write.csv(mr_ERN_table_rdoc_2, here("./tables/mr_ERN_table_rdoc_2.csv"))
# write.csv(mr_ERN_table_rdoc_2_raw, here("./tables/mr_ERN_table_rdoc_2_raw.csv"))
```

```{r, eval=FALSE}
summary(lmer(FCz_ERN_080_z ~ B11_avt_DO_av_sdv_a_incon + flanker_score_rdoc_z + accuracy_incongruent_z + rt_interference_z + Age + Pred_FSIQ_z + Motor_time_z + (1 | F_ID), 
             filter(LDDM_do3_rdoc_no_outliers, B11_avt_DO_av_sdv_a_incon<2)))

summary(lmer(FCz_ERN_080_z ~ B11_avt_DO_av_sdv_a_incon + flanker_score_rdoc_z + accuracy_incongruent_z + rt_interference_z + Age + Pred_FSIQ_z + Motor_time_z + (1 | F_ID), 
             filter(LDDM_do3_rdoc_no_outliers, B11_avtz_DO_avt_sdvz_a_incon<2)))

summary(lmer(FCz_ERN_080_z ~ B11_avt_DO_av_sdv_a_incon + (1 | F_ID), 
             filter(LDDM_do3_rdoc_no_outliers, B11_avt_DO_av_sdv_a_incon<2)))

summary(lmer(FCz_ERN_080_z ~ B11_avt_DO_av_sdv_a_incon + (1 | F_ID), 
             filter(LDDM_do3_rdoc_no_outliers, B11_avtz_DO_avt_sdvz_a_incon<2)))

summary(lmer(FCz_ERN_080_z ~ B11_avt_DO_av_sdv_a_con + flanker_score_rdoc_z + accuracy_incongruent_z + rt_interference_z + Age + Pred_FSIQ_z + Motor_time_z + (1 | F_ID), 
             filter(LDDM_do3_rdoc_no_outliers, B11_avt_DO_av_sdv_a_con<1.7)))
summary(lmer(FCz_ERN_080_z ~ B11_avt_DO_av_sdv_a_con + (1 | F_ID), 
             filter(LDDM_do3_rdoc_no_outliers, B11_avt_DO_av_sdv_a_con<1.7)))

plot1 <- ggplot(filter(LDDM_do3_rdoc_no_outliers, B11_avt_DO_av_sdv_a_con<1.7), aes(x=B11_avt_DO_av_sdv_a_con, y=FCz_ERN_080_z)) +
  geom_point() +
  stat_smooth(method="lm")
plot2 <- ggplot(filter(LDDM_do3_rdoc_no_outliers, B11_avt_DO_av_sdv_a_incon<2), aes(x=B11_avt_DO_av_sdv_a_incon, y=FCz_ERN_080_z)) +
  geom_point() +
  stat_smooth(method="lm")

plot3 <- ggplot(LDDM_do3_rdoc_no_outliers, aes(x=B11_avtz_DO_avt_sdvz_a_con, y=FCz_ERN_080_z)) +
  geom_point() +
  stat_smooth(method="lm")
plot4 <- ggplot(filter(LDDM_do3_rdoc_no_outliers, B11_avtz_DO_avt_sdvz_a_incon<2), aes(x=B11_avtz_DO_avt_sdvz_a_incon, y=FCz_ERN_080_z)) +
  geom_point() +
  stat_smooth(method="lm")

library(ggpubr)

ggarrange(plot1,plot2,plot3,plot4,
  ncol = 2,
  nrow = 2)
```

```{r old version, eval=FALSE}
i=1
mr_ERN_table_rdoc <- as.data.frame(matrix(nrow=4, ncol=4))
mr_ERN_table_rdoc[,1] <- c("Drift rate","Boundary separation","Non-decision time","Starting bias")
mr_ERN_table_rdoc_raw <- as.data.frame(matrix(nrow=4, ncol=4))
mr_ERN_table_rdoc_raw[,1] <- c("Drift rate","Boundary separation","Non-decision time","Starting bias")

for (var in c("B11_avtz_v_z","B11_avtz_a_z","B11_avtz_t_z","B11_avtz_z_z")) {
  eval(parse(text=paste0("
             model <- lmer(FCz_ERN_080_z ~ ",var," + flanker_score_rdoc_z + accuracy_incongruent_z + rt_interference_z + Age + Pred_FSIQ_z + Motor_time_z + (1 | F_ID), LDDM_do3_rdoc_no_outliers)
             
             mr_ERN_table_rdoc[i,2] <- paste0(round(tidy(model)$estimate[2],2), ifelse(tidy(model)$p.value[2]<0.01, '** ', ifelse(tidy(model)$p.value[2]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[4,1], confint(model)[4,2]))
             mr_ERN_table_rdoc[i,3] <- paste0(round(tidy(model)$estimate[3],2), ifelse(tidy(model)$p.value[3]<0.01, '** ', ifelse(tidy(model)$p.value[3]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[5,1], confint(model)[5,2]))
             mr_ERN_table_rdoc[i,4] <- paste0(round(tidy(model)$estimate[4],2), ifelse(tidy(model)$p.value[4]<0.01, '** ', ifelse(tidy(model)$p.value[4]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[6,1], confint(model)[6,2]))
             mr_ERN_table_rdoc[i,5] <- paste0(round(tidy(model)$estimate[5],2), ifelse(tidy(model)$p.value[5]<0.01, '** ', ifelse(tidy(model)$p.value[5]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[7,1], confint(model)[7,2]))

            mr_ERN_table_rdoc_raw[i,2] <- tidy(model)$estimate[2]
            mr_ERN_table_rdoc_raw[i,3] <- confint(model)[4,1]
            mr_ERN_table_rdoc_raw[i,4] <- confint(model)[4,2]
            
            mr_ERN_table_rdoc_raw[i,5] <- tidy(model)$estimate[3]
            mr_ERN_table_rdoc_raw[i,6] <- confint(model)[5,1]
            mr_ERN_table_rdoc_raw[i,7] <- confint(model)[5,2]
            
            mr_ERN_table_rdoc_raw[i,8] <- tidy(model)$estimate[4]
            mr_ERN_table_rdoc_raw[i,9] <- confint(model)[6,1]
            mr_ERN_table_rdoc_raw[i,10] <- confint(model)[6,2]
            
            mr_ERN_table_rdoc_raw[i,11] <- tidy(model)$estimate[5]
            mr_ERN_table_rdoc_raw[i,12] <- confint(model)[7,1]
            mr_ERN_table_rdoc_raw[i,13] <- confint(model)[7,2]
                                   ")))
  i=i+1
}

i=1
mr_ERN_table_rdoc_congruent <- mr_ERN_table_rdoc
mr_ERN_table_rdoc_congruent_raw <- mr_ERN_table_rdoc_raw
for (var in c("B11_avtz_v_z","B11_avtz_a_z","B11_avtz_t_z","B11_avtz_z_z")) {
  eval(parse(text=paste0("
             model <- lmer(FCz_ERN_080_z ~ ",var," + flanker_score_rdoc_z + accuracy_congruent_log_z + rt_interference_z + Age + Pred_FSIQ_z + Motor_time_z + (1 | F_ID), LDDM_do3_rdoc_no_outliers)
             
             mr_ERN_table_rdoc_congruent[i,2] <- paste0(round(tidy(model)$estimate[2],2), ifelse(tidy(model)$p.value[2]<0.01, '** ', ifelse(tidy(model)$p.value[2]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[4,1], confint(model)[4,2]))
             mr_ERN_table_rdoc_congruent[i,3] <- paste0(round(tidy(model)$estimate[3],2), ifelse(tidy(model)$p.value[3]<0.01, '** ', ifelse(tidy(model)$p.value[3]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[5,1], confint(model)[5,2]))
             mr_ERN_table_rdoc_congruent[i,4] <- paste0(round(tidy(model)$estimate[4],2), ifelse(tidy(model)$p.value[4]<0.01, '** ', ifelse(tidy(model)$p.value[4]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[6,1], confint(model)[6,2]))
             mr_ERN_table_rdoc_congruent[i,5] <- paste0(round(tidy(model)$estimate[5],2), ifelse(tidy(model)$p.value[5]<0.01, '** ', ifelse(tidy(model)$p.value[5]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[7,1], confint(model)[7,2]))

            mr_ERN_table_rdoc_congruent_raw[i,2] <- tidy(model)$estimate[2]
            mr_ERN_table_rdoc_congruent_raw[i,3] <- confint(model)[4,1]
            mr_ERN_table_rdoc_congruent_raw[i,4] <- confint(model)[4,2]
            
            mr_ERN_table_rdoc_congruent_raw[i,5] <- tidy(model)$estimate[3]
            mr_ERN_table_rdoc_congruent_raw[i,6] <- confint(model)[5,1]
            mr_ERN_table_rdoc_congruent_raw[i,7] <- confint(model)[5,2]
            
            mr_ERN_table_rdoc_congruent_raw[i,8] <- tidy(model)$estimate[4]
            mr_ERN_table_rdoc_congruent_raw[i,9] <- confint(model)[6,1]
            mr_ERN_table_rdoc_congruent_raw[i,10] <- confint(model)[6,2]
            
            mr_ERN_table_rdoc_congruent_raw[i,11] <- tidy(model)$estimate[5]
            mr_ERN_table_rdoc_congruent_raw[i,12] <- confint(model)[7,1]
            mr_ERN_table_rdoc_congruent_raw[i,13] <- confint(model)[7,2]
                                   ")))
  i=i+1
}

colnames(mr_ERN_table_rdoc) <- c("Parameters","Drift rate", "NIH Toolbox", "Raw accuracy", "RT interference")
colnames(mr_ERN_table_rdoc_congruent) <- c("Parameters","Drift rate", "NIH Toolbox", "Raw accuracy (congruent log)", "RT interference")

write.csv(mr_ERN_table_rdoc, here("./tables/mr_ERN_table_rdoc.csv"))
write.csv(mr_ERN_table_rdoc_raw, here("./tables/mr_ERN_table_rdoc_raw.csv"))

write.csv(mr_ERN_table_rdoc_congruent, here("./tables/mr_ERN_table_rdoc_congruent.csv"))
write.csv(mr_ERN_table_rdoc_congruent_raw, here("./tables/mr_ERN_table_rdoc_congruent_raw.csv"))
```

## Neuropsych measures
### Inhibition & DDM 
```{r}
i=1
mr_INHIB_table_rdoc_nocov <- as.data.frame(matrix(nrow=length(var_names), ncol=5))
mr_INHIB_table_rdoc_nocov[,1] <- mr_ERN_table_rdoc[,1]
mr_INHIB_table_rdoc_nocov_raw <- as.data.frame(matrix(nrow=length(var_names), ncol=13))
mr_INHIB_table_rdoc_nocov_raw[,1] <- mr_ERN_table_rdoc[,1]

mr_INHIB_table_rdoc_cov <- mr_INHIB_table_rdoc_nocov
mr_INHIB_table_rdoc_cov_raw <- as.data.frame(matrix(nrow=length(var_names), ncol=13))
mr_INHIB_table_rdoc_cov_raw[,1] <- mr_ERN_table_rdoc[,1]

colnames(mr_INHIB_table_rdoc_nocov) <- c("Parameters","DDM", "NIH Toolbox", "Raw accuracy", "RT Interference")
colnames(mr_INHIB_table_rdoc_cov) <- c("Parameters","DDM", "NIH Toolbox", "Raw accuracy", "RT Interference")

for (var in paste0(map(var_abbreviations, str_subset, string = var_list) %>% reduce(union),"_z")) {
  eval(parse(text=paste0("
             model <- lmer(Inhib_time_rev_z ~ ",var," + flanker_score_rdoc_z + accuracy_incongruent_z + rt_interference_z + (1 | F_ID), LDDM_do3_rdoc_no_outliers)
             
             mr_INHIB_table_rdoc_nocov[i,2] <- paste0(round(tidy(model)$estimate[2],2), ifelse(tidy(model)$p.value[2]<0.01, '** ', ifelse(tidy(model)$p.value[2]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[4,1], confint(model)[4,2]))
             mr_INHIB_table_rdoc_nocov[i,3] <- paste0(round(tidy(model)$estimate[3],2), ifelse(tidy(model)$p.value[3]<0.01, '** ', ifelse(tidy(model)$p.value[3]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[5,1], confint(model)[5,2]))
             mr_INHIB_table_rdoc_nocov[i,4] <- paste0(round(tidy(model)$estimate[4],2), ifelse(tidy(model)$p.value[4]<0.01, '** ', ifelse(tidy(model)$p.value[4]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[6,1], confint(model)[6,2]))
             mr_INHIB_table_rdoc_nocov[i,5] <- paste0(round(tidy(model)$estimate[5],2), ifelse(tidy(model)$p.value[5]<0.01, '** ', ifelse(tidy(model)$p.value[5]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[7,1], confint(model)[7,2]))
                                            
            mr_INHIB_table_rdoc_nocov_raw[i,2] <- tidy(model)$estimate[2]
            mr_INHIB_table_rdoc_nocov_raw[i,3] <- confint(model)[4,1]
            mr_INHIB_table_rdoc_nocov_raw[i,4] <- confint(model)[4,2]

            mr_INHIB_table_rdoc_nocov_raw[i,5] <- tidy(model)$estimate[3]
            mr_INHIB_table_rdoc_nocov_raw[i,6] <- confint(model)[5,1]
            mr_INHIB_table_rdoc_nocov_raw[i,7] <- confint(model)[5,2]

            mr_INHIB_table_rdoc_nocov_raw[i,8] <- tidy(model)$estimate[4]
            mr_INHIB_table_rdoc_nocov_raw[i,9] <- confint(model)[6,1]
            mr_INHIB_table_rdoc_nocov_raw[i,10] <- confint(model)[6,2]

            mr_INHIB_table_rdoc_nocov_raw[i,11] <- tidy(model)$estimate[5]
            mr_INHIB_table_rdoc_nocov_raw[i,12] <- confint(model)[7,1]
            mr_INHIB_table_rdoc_nocov_raw[i,13] <- confint(model)[7,2]
            
             model_cov <- lmer(Inhib_time_rev_z ~ ",var," + flanker_score_rdoc_z + accuracy_incongruent_z + rt_interference_z + Age + Pred_FSIQ + Motor_time + (1 | F_ID), LDDM_do3_rdoc_no_outliers)
             
             mr_INHIB_table_rdoc_cov[i,2] <- paste0(round(tidy(model_cov)$estimate[2],2), ifelse(tidy(model_cov)$p.value[2]<0.01, '** ', ifelse(tidy(model_cov)$p.value[2]<0.05, '* ', ' ')), 
                                            make_CI(confint(model_cov)[4,1], confint(model_cov)[4,2]))
             mr_INHIB_table_rdoc_cov[i,3] <- paste0(round(tidy(model_cov)$estimate[3],2), ifelse(tidy(model_cov)$p.value[3]<0.01, '** ', ifelse(tidy(model_cov)$p.value[3]<0.05, '* ', ' ')), 
                                            make_CI(confint(model_cov)[5,1], confint(model_cov)[5,2]))
             mr_INHIB_table_rdoc_cov[i,4] <- paste0(round(tidy(model_cov)$estimate[4],2), ifelse(tidy(model_cov)$p.value[4]<0.01, '** ', ifelse(tidy(model_cov)$p.value[4]<0.05, '* ', ' ')), 
                                            make_CI(confint(model_cov)[6,1], confint(model_cov)[6,2]))
             mr_INHIB_table_rdoc_cov[i,5] <- paste0(round(tidy(model_cov)$estimate[5],2), ifelse(tidy(model_cov)$p.value[5]<0.01, '** ', ifelse(tidy(model_cov)$p.value[5]<0.05, '* ', ' ')), 
                                            make_CI(confint(model_cov)[7,1], confint(model_cov)[7,2]))
                                            
            mr_INHIB_table_rdoc_cov_raw[i,2] <- tidy(model_cov)$estimate[2]
            mr_INHIB_table_rdoc_cov_raw[i,3] <- confint(model_cov)[4,1]
            mr_INHIB_table_rdoc_cov_raw[i,4] <- confint(model_cov)[4,2]

            mr_INHIB_table_rdoc_cov_raw[i,5] <- tidy(model_cov)$estimate[3]
            mr_INHIB_table_rdoc_cov_raw[i,6] <- confint(model_cov)[5,1]
            mr_INHIB_table_rdoc_cov_raw[i,7] <- confint(model_cov)[5,2]

            mr_INHIB_table_rdoc_cov_raw[i,8] <- tidy(model_cov)$estimate[4]
            mr_INHIB_table_rdoc_cov_raw[i,9] <- confint(model_cov)[6,1]
            mr_INHIB_table_rdoc_cov_raw[i,10] <- confint(model_cov)[6,2]

            mr_INHIB_table_rdoc_cov_raw[i,11] <- tidy(model_cov)$estimate[5]
            mr_INHIB_table_rdoc_cov_raw[i,12] <- confint(model_cov)[7,1]
            mr_INHIB_table_rdoc_cov_raw[i,13] <- confint(model_cov)[7,2]
                                   ")))
  i=i+1
}

write.csv(mr_INHIB_table_rdoc_nocov, here("./tables/mr_INHIB_table_rdoc_nocov.csv"))
write.csv(mr_INHIB_table_rdoc_cov, here("./tables/mr_INHIB_table_rdoc_cov.csv"))
write.csv(mr_INHIB_table_rdoc_nocov_raw, here("./tables/mr_INHIB_table_rdoc_nocov_raw.csv"))
write.csv(mr_INHIB_table_rdoc_cov_raw, here("./tables/mr_INHIB_table_rdoc_cov_raw.csv"))
```

### Set-shifting & DDM 
```{r}
i=1
mr_EXEC_table_rdoc_nocov <- as.data.frame(matrix(nrow=length(var_names), ncol=5))
mr_EXEC_table_rdoc_nocov[,1] <- mr_ERN_table_rdoc[,1]
mr_EXEC_table_rdoc_nocov_raw <- as.data.frame(matrix(nrow=length(var_names), ncol=13))
mr_EXEC_table_rdoc_nocov_raw[,1] <- mr_ERN_table_rdoc[,1]

mr_EXEC_table_rdoc_cov <- mr_EXEC_table_rdoc_nocov
mr_EXEC_table_rdoc_cov_raw <- as.data.frame(matrix(nrow=length(var_names), ncol=13))
mr_EXEC_table_rdoc_cov_raw[,1] <- mr_ERN_table_rdoc[,1]

for (var in paste0(map(var_abbreviations, str_subset, string = var_list) %>% reduce(union),"_z")) {
  eval(parse(text=paste0("
             model <- lmer(exec_composite_z ~ ",var," + flanker_score_rdoc_z + accuracy_incongruent_z + rt_interference_z  + (1 | F_ID), LDDM_do3_rdoc_no_outliers)
             
             mr_EXEC_table_rdoc_nocov[i,2] <- paste0(round(tidy(model)$estimate[2],2), ifelse(tidy(model)$p.value[2]<0.01, '** ', ifelse(tidy(model)$p.value[2]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[4,1], confint(model)[4,2]))
             mr_EXEC_table_rdoc_nocov[i,3] <- paste0(round(tidy(model)$estimate[3],2), ifelse(tidy(model)$p.value[3]<0.01, '** ', ifelse(tidy(model)$p.value[3]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[5,1], confint(model)[5,2]))
             mr_EXEC_table_rdoc_nocov[i,4] <- paste0(round(tidy(model)$estimate[4],2), ifelse(tidy(model)$p.value[4]<0.01, '** ', ifelse(tidy(model)$p.value[4]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[6,1], confint(model)[6,2]))
             mr_EXEC_table_rdoc_nocov[i,5] <- paste0(round(tidy(model)$estimate[5],2), ifelse(tidy(model)$p.value[5]<0.01, '** ', ifelse(tidy(model)$p.value[5]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[7,1], confint(model)[7,2]))
                                            
            mr_EXEC_table_rdoc_nocov_raw[i,2] <- tidy(model)$estimate[2]
            mr_EXEC_table_rdoc_nocov_raw[i,3] <- confint(model)[4,1]
            mr_EXEC_table_rdoc_nocov_raw[i,4] <- confint(model)[4,2]

            mr_EXEC_table_rdoc_nocov_raw[i,5] <- tidy(model)$estimate[3]
            mr_EXEC_table_rdoc_nocov_raw[i,6] <- confint(model)[5,1]
            mr_EXEC_table_rdoc_nocov_raw[i,7] <- confint(model)[5,2]

            mr_EXEC_table_rdoc_nocov_raw[i,8] <- tidy(model)$estimate[4]
            mr_EXEC_table_rdoc_nocov_raw[i,9] <- confint(model)[6,1]
            mr_EXEC_table_rdoc_nocov_raw[i,10] <- confint(model)[6,2]

            mr_EXEC_table_rdoc_nocov_raw[i,11] <- tidy(model)$estimate[5]
            mr_EXEC_table_rdoc_nocov_raw[i,12] <- confint(model)[7,1]
            mr_EXEC_table_rdoc_nocov_raw[i,13] <- confint(model)[7,2]
            
             model_cov <- lmer(exec_composite_z ~ ",var," + flanker_score_rdoc_z + accuracy_incongruent_z + rt_interference_z + Age + Pred_FSIQ + Motor_time + (1 | F_ID), LDDM_do3_rdoc_no_outliers)
             
             mr_EXEC_table_rdoc_cov[i,2] <- paste0(round(tidy(model_cov)$estimate[2],2), ifelse(tidy(model_cov)$p.value[2]<0.01, '** ', ifelse(tidy(model_cov)$p.value[2]<0.05, '* ', ' ')), 
                                            make_CI(confint(model_cov)[4,1], confint(model_cov)[4,2]))
             mr_EXEC_table_rdoc_cov[i,3] <- paste0(round(tidy(model_cov)$estimate[3],2), ifelse(tidy(model_cov)$p.value[3]<0.01, '** ', ifelse(tidy(model_cov)$p.value[3]<0.05, '* ', ' ')), 
                                            make_CI(confint(model_cov)[5,1], confint(model_cov)[5,2]))
             mr_EXEC_table_rdoc_cov[i,4] <- paste0(round(tidy(model_cov)$estimate[4],2), ifelse(tidy(model_cov)$p.value[4]<0.01, '** ', ifelse(tidy(model_cov)$p.value[4]<0.05, '* ', ' ')), 
                                            make_CI(confint(model_cov)[6,1], confint(model_cov)[6,2]))
             mr_EXEC_table_rdoc_cov[i,5] <- paste0(round(tidy(model_cov)$estimate[5],2), ifelse(tidy(model_cov)$p.value[5]<0.01, '** ', ifelse(tidy(model_cov)$p.value[5]<0.05, '* ', ' ')), 
                                            make_CI(confint(model_cov)[7,1], confint(model_cov)[7,2]))
                                            
            mr_EXEC_table_rdoc_cov_raw[i,2] <- tidy(model_cov)$estimate[2]
            mr_EXEC_table_rdoc_cov_raw[i,3] <- confint(model_cov)[4,1]
            mr_EXEC_table_rdoc_cov_raw[i,4] <- confint(model_cov)[4,2]

            mr_EXEC_table_rdoc_cov_raw[i,5] <- tidy(model_cov)$estimate[3]
            mr_EXEC_table_rdoc_cov_raw[i,6] <- confint(model_cov)[5,1]
            mr_EXEC_table_rdoc_cov_raw[i,7] <- confint(model_cov)[5,2]

            mr_EXEC_table_rdoc_cov_raw[i,8] <- tidy(model_cov)$estimate[4]
            mr_EXEC_table_rdoc_cov_raw[i,9] <- confint(model_cov)[6,1]
            mr_EXEC_table_rdoc_cov_raw[i,10] <- confint(model_cov)[6,2]

            mr_EXEC_table_rdoc_cov_raw[i,11] <- tidy(model_cov)$estimate[5]
            mr_EXEC_table_rdoc_cov_raw[i,12] <- confint(model_cov)[7,1]
            mr_EXEC_table_rdoc_cov_raw[i,13] <- confint(model_cov)[7,2]
                                   ")))
  i=i+1
}

write.csv(mr_EXEC_table_rdoc_nocov, here("./tables/mr_Exec_table_rdoc_nocov.csv"))
write.csv(mr_EXEC_table_rdoc_cov, here("./tables/mr_Exec_table_rdoc_cov.csv"))
write.csv(mr_EXEC_table_rdoc_nocov_raw, here("./tables/mr_EXEC_table_rdoc_nocov_raw.csv"))
write.csv(mr_EXEC_table_rdoc_cov_raw, here("./tables/mr_EXEC_table_rdoc_cov_raw.csv"))
```

# Heritability
```{r}
LDDM_do3_rdoc_sib <- LDDM_do3_rdoc %>%
  group_by(ID) %>%
  arrange(ID) %>%
  filter(row_number()==1) %>%
  pivot_wider(id_cols=F_ID, names_from=S_ID, values_from=var_list)

LDDM_heritability_table <- data.frame(parameters= var_list[1:10],
                           ICC=c(icc(LDDM_do3_rdoc_sib[c(paste0(var_list[1],"_1"),paste0(var_list[1],"_2"))])$value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[2],"_1"),paste0(var_list[2],"_2"))])$value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[3],"_1"),paste0(var_list[3],"_2"))])$value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[4],"_1"),paste0(var_list[4],"_2"))])$value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[5],"_1"),paste0(var_list[5],"_2"))])$value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[6],"_1"),paste0(var_list[6],"_2"))])$value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[7],"_1"),paste0(var_list[7],"_2"))])$value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[8],"_1"),paste0(var_list[8],"_2"))])$value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[9],"_1"),paste0(var_list[9],"_2"))])$value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[10],"_1"),paste0(var_list[10],"_2"))])$value),
                           p=c(icc(LDDM_do3_rdoc_sib[c(paste0(var_list[1],"_1"),paste0(var_list[1],"_2"))])$p.value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[2],"_1"),paste0(var_list[2],"_2"))])$p.value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[3],"_1"),paste0(var_list[3],"_2"))])$p.value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[4],"_1"),paste0(var_list[4],"_2"))])$p.value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[5],"_1"),paste0(var_list[5],"_2"))])$p.value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[6],"_1"),paste0(var_list[6],"_2"))])$p.value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[7],"_1"),paste0(var_list[7],"_2"))])$p.value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[8],"_1"),paste0(var_list[8],"_2"))])$p.value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[9],"_1"),paste0(var_list[9],"_2"))])$p.value,
                                 icc(LDDM_do3_rdoc_sib[c(paste0(var_list[10],"_1"),paste0(var_list[10],"_2"))])$p.value))

write.csv(LDDM_heritability_table, here("./tables/rdoc_heritability_table.csv"))
```


# Split half reliability (Spearman-Brown prophecy)
```{r}
load(file=here("./data/LDDM_cleaning04_fullbeh_rdoc.RData"))

LDDM_cleaning04_rdoc_reliability <- LDDM_cleaning04_fullbeh_rdoc %>%
  group_by(subj_idx) %>%
  mutate(block = c(rep(1,30),rep(2,30),rep(3,30),rep(4,30),rep(5,30),rep(6,30),rep(7,30),rep(8,30),rep(9,30),rep(10,30),rep(11,30))) %>%
  group_by(subj_idx) %>%
  mutate(trial = 1:330)

for (s in seq(15,166,15)){
    eval(parse(text=paste0('
LDDM_first',s,'_1 <- LDDM_cleaning04_rdoc_reliability %>% filter(trial<=',s,')
LDDM_second',s,'_1 <- LDDM_cleaning04_rdoc_reliability %>% filter(trial< ',(s*2)+1,' & trial>',s,')
  
LDDM_first',s,'_2 <- LDDM_first',s,'_1 %>%
  group_by(subj_idx) %>% # per subject
  reframe(accuracy_score = sum(response==1)*(5/length(trial))) # accuracy score per NIH Toolbox manual
LDDM_second',s,'_2 <- LDDM_second',s,'_1 %>%
  group_by(subj_idx) %>%
  reframe(accuracy_score = sum(response==1)*(5/length(trial))) # accuracy score per NIH Toolbox manual

LDDM_first',s,'_3 <-  LDDM_first',s,'_1 %>%
  group_by(subj_idx) %>% # per subject
  filter(stim=="incongruent" & response==1) %>% # incongruent trials with correct response
  mutate(mean_rt = mean(rt),
         sd_rt = sd(rt)) %>% # compute individual mean and sd RT for use below
  filter(rt>=0.1 & rt>(mean_rt - 3*sd_rt) & rt<(mean_rt + 3*sd_rt)) %>% # remove trials less than 100ms and less than 3SD below or 3SD above the mean RT
  reframe(med_rt = median(rt)*1000) %>% # compute individual level median RT
  mutate(rt_score = 5-(5*((log(med_rt)-log(250))/(log(1000)-log(250))))) # compute RT score to go into flanker score
LDDM_second',s,'_3 <-  LDDM_second',s,'_1 %>%
  group_by(subj_idx) %>% # per subject
  filter(stim=="incongruent" & response==1) %>% # incongruent trials with correct response
  mutate(mean_rt = mean(rt),
         sd_rt = sd(rt)) %>% # compute individual mean and sd RT for use below
  filter(rt>=0.1 & rt>(mean_rt - 3*sd_rt) & rt<(mean_rt + 3*sd_rt)) %>% # remove trials less than 100ms and less than 3SD below or 3SD above the mean RT
  reframe(med_rt = median(rt)*1000) %>% # compute individual level median RT
  mutate(rt_score = 5-(5*((log(med_rt)-log(250))/(log(1000)-log(250))))) # compute RT score to go into flanker score

LDDM_first',s,' <- LDDM_first',s,'_1 %>%
  full_join(LDDM_first',s,'_2, by = "subj_idx") %>%
  full_join(LDDM_first',s,'_3, by="subj_idx") %>%
  group_by(subj_idx) %>% # per subject
  mutate(total_accuracy_perc = sum(response==1)/length(response)) %>% # compute total accuracy percentage
  reframe(flanker_score_list_rdoc = if_else(total_accuracy_perc>=0.8, accuracy_score+rt_score, accuracy_score),
            accuracy = mean(total_accuracy_perc)) %>% # if accuracy is above 80% then add accuracy and rt flanker scores, if not base the flanker score only on accuracy; also compute a regular percentage based accuracy (ie percent of trials when subject was correct)
  transmute(ID=subj_idx, flanker_score_list_rdoc=flanker_score_list_rdoc, accuracy=accuracy) %>%
  group_by(ID) %>% # per subject
  reframe(flanker_score_rdoc = mean(flanker_score_list_rdoc),
            accuracy = mean(accuracy))
LDDM_second',s,' <- LDDM_second',s,'_1 %>%
  full_join(LDDM_second',s,'_2, by = "subj_idx") %>%
  full_join(LDDM_second',s,'_3, by="subj_idx") %>%
  group_by(subj_idx) %>% # per subject
  mutate(total_accuracy_perc = sum(response==1)/length(response)) %>% # compute total accuracy percentage
  reframe(flanker_score_list_rdoc = if_else(total_accuracy_perc>=0.8, accuracy_score+rt_score, accuracy_score),
            accuracy = mean(total_accuracy_perc)) %>% # if accuracy is above 80% then add accuracy and rt flanker scores, if not base the flanker score only on accuracy; also compute a regular percentage based accuracy (ie percent of trials when subject was correct)
  transmute(ID=subj_idx, flanker_score_list_rdoc=flanker_score_list_rdoc, accuracy=accuracy) %>%
  group_by(ID) %>% # per subject
  reframe(flanker_score_rdoc = mean(flanker_score_list_rdoc),
            accuracy = mean(accuracy))
            
# RT of correct responses, and interference effect difference score (RT of incongruent - congruent)
LDDM_first_rt',s,'<- LDDM_first',s,'_1 %>%
  group_by(subj_idx) %>%
  mutate(rt_correct = ifelse(response==1, median(rt, na.rm=TRUE), NA)) %>%
    pivot_wider(names_from=stim, id_cols=c(subj_idx, response, block, trial, rt_correct), values_from=rt, names_prefix="rt_") %>%
    group_by(subj_idx) %>%
    reframe(rt_correct = median(rt_correct, na.rm=TRUE),
            rt_interference = median(rt_incongruent, na.rm=TRUE)-median(rt_congruent, na.rm=TRUE)) %>%
  mutate(ID=subj_idx) %>%
  select(-subj_idx)
LDDM_second_rt',s,'<- LDDM_second',s,'_1 %>%
  group_by(subj_idx) %>%
  mutate(rt_correct = ifelse(response==1, median(rt, na.rm=TRUE), NA)) %>%
    pivot_wider(names_from=stim, id_cols=c(subj_idx, response, block, trial, rt_correct), values_from=rt, names_prefix="rt_") %>%
    group_by(subj_idx) %>%
    reframe(rt_correct = median(rt_correct, na.rm=TRUE),
            rt_interference = median(rt_incongruent, na.rm=TRUE)-median(rt_congruent, na.rm=TRUE)) %>%
  mutate(ID=subj_idx) %>%
  select(-subj_idx)

LDDM_first_accuracy',s,'<- LDDM_first',s,'_1 %>%
  full_join(LDDM_first',s,'_2, by = "subj_idx") %>%
  full_join(LDDM_first',s,'_3, by="subj_idx") %>%
  group_by(subj_idx, stim) %>% # per subject and condition
  mutate(accuracy_by_stim = sum(response==1)/length(response)) %>%
  reframe(accuracy_by_stim=mean(accuracy_by_stim)) %>%
  pivot_wider(names_from=stim, values_from=accuracy_by_stim, id_cols=subj_idx, names_prefix="accuracy_")
LDDM_second_accuracy',s,'<- LDDM_second',s,'_1 %>%
  full_join(LDDM_second',s,'_2, by = "subj_idx") %>%
  full_join(LDDM_second',s,'_3, by="subj_idx") %>%
  group_by(subj_idx, stim) %>% # per subject and condition
  mutate(accuracy_by_stim = sum(response==1)/length(response)) %>%
  reframe(accuracy_by_stim=mean(accuracy_by_stim)) %>%
  pivot_wider(names_from=stim, values_from=accuracy_by_stim, id_cols=subj_idx, names_prefix="accuracy_")
            
r_half_',s,' <- cor(LDDM_first',s,'$flanker_score_rdoc, LDDM_second',s,'$flanker_score_rdoc, method="pearson", use="pairwise")
r_half_ci_',s,' <- ci_cor(LDDM_first',s,'$flanker_score_rdoc, LDDM_second',s,'$flanker_score_rdoc, method="pearson", type = "bootstrap", R=1000)
r_sb_cilower_',s,' <- (2*r_half_ci_',s,'$interval[1])/(1+r_half_ci_',s,'$interval[1])
r_sb_ciupper_',s,' <- (2*r_half_ci_',s,'$interval[2])/(1+r_half_ci_',s,'$interval[2])
r_sb_',s,' <- (2*r_half_',s,')/(1+r_half_',s,')

racc_half_',s,' <- cor(LDDM_first_accuracy',s,'$accuracy_incongruent, LDDM_second_accuracy',s,'$accuracy_incongruent, method="pearson")
racc_half_ci_',s,' <- ci_cor(LDDM_first_accuracy',s,'$accuracy_incongruent, LDDM_second_accuracy',s,'$accuracy_incongruent, method="pearson", type = "bootstrap", R=1000)
racc_sb_cilower_',s,' <- (2*racc_half_ci_',s,'$interval[1])/(1+racc_half_ci_',s,'$interval[1])
racc_sb_ciupper_',s,' <- (2*racc_half_ci_',s,'$interval[2])/(1+racc_half_ci_',s,'$interval[2])
racc_sb_',s,' <- (2*racc_half_',s,')/(1+racc_half_',s,')

rrt_half_',s,' <- cor(LDDM_first_rt',s,'$rt_interference, LDDM_second_rt',s,'$rt_interference, method="pearson")
rrt_half_ci_',s,' <- ci_cor(LDDM_first_rt',s,'$rt_interference, LDDM_second_rt',s,'$rt_interference, method="pearson", type = "bootstrap", R=1000)
rrt_sb_cilower_',s,' <- (2*rrt_half_ci_',s,'$interval[1])/(1+rrt_half_ci_',s,'$interval[1])
rrt_sb_ciupper_',s,' <- (2*rrt_half_ci_',s,'$interval[2])/(1+rrt_half_ci_',s,'$interval[2])
rrt_sb_',s,' <- (2*rrt_half_',s,')/(1+rrt_half_',s,')
')))
}

rdoc_ddm_splithalf <- read.csv(here("./data/RDoC_splithalf_avtz_DO_vta_sdvz.csv"), header=TRUE)

spearman_brown_rdoc <- data.frame(trials=seq(15,165,15),
                                  # DDM measures
                             racon=rep(NA,length(seq(15,165,15))),
                             racon_cilower=rep(NA,length(seq(15,165,15))),
                             racon_ciupper=rep(NA,length(seq(15,165,15))),
                             raincon=rep(NA,length(seq(15,165,15))),
                             raincon_cilower=rep(NA,length(seq(15,165,15))),
                             raincon_ciupper=rep(NA,length(seq(15,165,15))),
                             rvcon=rep(NA,length(seq(15,165,15))),
                             rvcon_cilower=rep(NA,length(seq(15,165,15))),
                             rvcon_ciupper=rep(NA,length(seq(15,165,15))),
                             rvincon=rep(NA,length(seq(15,165,15))),
                             rvincon_cilower=rep(NA,length(seq(15,165,15))),
                             rvincon_ciupper=rep(NA,length(seq(15,165,15))),
                                 # Traditional measures
                             rnih=rep(NA,length(seq(15,165,15))),
                             rnih_cilower=rep(NA,length(seq(15,165,15))),
                             rnih_ciupper=rep(NA,length(seq(15,165,15))),
                             racc=rep(NA,length(seq(15,165,15))),
                             racc_cilower=rep(NA,length(seq(15,165,15))),
                             racc_ciupper=rep(NA,length(seq(15,165,15))),
                             rrt=rep(NA,length(seq(15,165,15))),
                             rrt_cilower=rep(NA,length(seq(15,165,15))),
                             rrt_ciupper=rep(NA,length(seq(15,165,15))))
# i=1
# for (s in seq(1,11)){
#   eval(parse(text=paste0('
#                          spearman_brown_rdoc[i,2] <- round(as.numeric(r_v_sb_B',s,'),3)
#                          spearman_brown_rdoc[i,3] <- round(as.numeric(r_v_sb_cilower_B',s,'),3)
#                          spearman_brown_rdoc[i,4] <- round(as.numeric(r_v_sb_ciupper_B',s,'),3)
# 
#                          spearman_brown_rdoc[i,5] <- round(as.numeric(r_a_sb_B',s,'),3)
#                          spearman_brown_rdoc[i,6] <- round(as.numeric(r_a_sb_cilower_B',s,'),3)
#                          spearman_brown_rdoc[i,7] <- round(as.numeric(r_a_sb_ciupper_B',s,'),3)
#                          ')))
#   i=i+1
# }

i=1
for (s in seq(15,165,15)){
  eval(parse(text=paste0('
                         spearman_brown_rdoc[,dim(spearman_brown_rdoc)[2]-20] <- round(rdoc_ddm_splithalf[,2],3)
                         spearman_brown_rdoc[,dim(spearman_brown_rdoc)[2]-19] <- round(rdoc_ddm_splithalf[,3],3)
                         spearman_brown_rdoc[,dim(spearman_brown_rdoc)[2]-18] <- round(rdoc_ddm_splithalf[,4],3)
                         spearman_brown_rdoc[,dim(spearman_brown_rdoc)[2]-17] <- round(rdoc_ddm_splithalf[,5],3)
                         spearman_brown_rdoc[,dim(spearman_brown_rdoc)[2]-16] <- round(rdoc_ddm_splithalf[,6],3)
                         spearman_brown_rdoc[,dim(spearman_brown_rdoc)[2]-15] <- round(rdoc_ddm_splithalf[,7],3)
                         spearman_brown_rdoc[,dim(spearman_brown_rdoc)[2]-14] <- round(rdoc_ddm_splithalf[,8],3)
                         spearman_brown_rdoc[,dim(spearman_brown_rdoc)[2]-13] <- round(rdoc_ddm_splithalf[,9],3)
                         spearman_brown_rdoc[,dim(spearman_brown_rdoc)[2]-12] <- round(rdoc_ddm_splithalf[,10],3)
                         spearman_brown_rdoc[,dim(spearman_brown_rdoc)[2]-11] <- round(rdoc_ddm_splithalf[,11],3)
                         spearman_brown_rdoc[,dim(spearman_brown_rdoc)[2]-10] <- round(rdoc_ddm_splithalf[,12],3)
                         spearman_brown_rdoc[,dim(spearman_brown_rdoc)[2]-9] <- round(rdoc_ddm_splithalf[,13],3)
                         spearman_brown_rdoc[i,dim(spearman_brown_rdoc)[2]-8] <- round(as.numeric(r_sb_',s,'),3)
                         spearman_brown_rdoc[i,dim(spearman_brown_rdoc)[2]-7] <- round(as.numeric(r_sb_cilower_',s,'),3)
                         spearman_brown_rdoc[i,dim(spearman_brown_rdoc)[2]-6] <- round(as.numeric(r_sb_ciupper_',s,'),3)
                         spearman_brown_rdoc[i,dim(spearman_brown_rdoc)[2]-5] <- round(as.numeric(racc_sb_',s,'),3)
                         spearman_brown_rdoc[i,dim(spearman_brown_rdoc)[2]-4] <- round(as.numeric(racc_sb_cilower_',s,'),3)
                         spearman_brown_rdoc[i,dim(spearman_brown_rdoc)[2]-3] <- round(as.numeric(racc_sb_ciupper_',s,'),3)
                         spearman_brown_rdoc[i,dim(spearman_brown_rdoc)[2]-2] <- round(as.numeric(rrt_sb_',s,'),3)
                         spearman_brown_rdoc[i,dim(spearman_brown_rdoc)[2]-1] <- round(as.numeric(rrt_sb_cilower_',s,'),3)
                         spearman_brown_rdoc[i,dim(spearman_brown_rdoc)[2]] <- round(as.numeric(rrt_sb_ciupper_',s,'),3)')))
  i=i+1
}
```

This is for the method of calculating the Spearman-Brown values for the RDoC sample when using the model with the following parameters: a, t, z, v by condition.
```{r, eval=FALSE}
rdoc_ddm_splithalf <- read.csv(here("./Split_Half/RDoC_splithalf.csv"), header=TRUE)

spearman_brown_rdoc$rdriftcon <- rdoc_ddm_splithalf$v_D1_B1a
spearman_brown_rdoc$rdriftincon <- rdoc_ddm_splithalf$avtz_DO_v_vinc
spearman_brown_rdoc$rdrift <- rowMeans(rdoc_ddm_splithalf[,c("avtz_DO_v_vcon","avtz_DO_v_vinc")])
spearman_brown_rdoc$rboundary_separation <- rdoc_ddm_splithalf$avtz_DO_v_a

# ggplot(spearman_brown_rdoc, aes(x=trials, y=r, group=1)) +
#   geom_line() +
#   geom_point() +
#   scale_y_continuous(limits = c(0, 1)) +
#   geom_ribbon(aes(ymin = r_ci_lower, ymax = r_ci_upper), alpha = 0.2)
```
# Correlations
## ERN amplitude, Neuropsych, & DDM
```{r}
rdoc_correlations <- correlation_matrix(LDDM_do3_rdoc_no_outliers[c(var_list)], type = c("pearson"), use = 'lower', replace_diagonal=TRUE, replacement="")

write.csv(rdoc_correlations, file=here("./tables/rdoc_correlations.csv"))
```

# Save datasets
```{r}
save(LDDM_do3_rdoc_with_bad_data, file=here("./data/LDDM_do3_rdoc_with_bad_data.RData"))
save(LDDM_do3_rdoc, file=here("./data/LDDM_do3_rdoc.RData"))
save(LDDM_do3_rdoc_no_outliers, file=here("./data/LDDM_do3_rdoc_no_outliers.RData"))
save(spearman_brown_rdoc, file=here("./data/spearman_brown_rdoc.RData"))
```

