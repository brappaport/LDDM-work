---
title: "Data analysis script 2: Testing for replication of ERP to DDM concordance in RDoC dataset"
author: "Brent Rappaport"
date: "`r format(Sys.time(),  '%Y-%m-%d')`"
output:
  pdf_document: default
  html_document:
    df_print: paged
subtitle: Template Rmd
editor_options:
  chunk_output_type: console
toc: yes
---

# About
This script does preliminary data analysis comparing the psychometrics of HDDM models vs. raw accuracy vs. NIH Toolbox derived score for the Flanker task of the RDoC study.

v = **drift rate**: "The parameter of primary interest for the present study is the drift rate, v, which is the average rate of approach to a boundary and indexes the quality or strength of evidence extracted from the stimulus. A large value of drift indicates strong decision evidence, meaning the decision process will approach the appropriate boundary quickly, leading to fast and accurate responses." Larger values of v mean faster accumulation of evidence (faster rate), larger t means slower non-decision time processing.

z = **response bias**: "If participants were
biased toward one of the two responses (e.g., by increasing the proportion of one response over the other), they would move their starting point closer to that boundary. This produces faster and more probable responses at that boundary since less evidence is needed to reach it." Distance between the the start of the drift process and upper boundary.

a = **separation between the two boundaries**: "response caution or speed/accuracy tradeoffs. If the boundary separation is relatively small, responses will take less time to reach a boundary, leading to faster responses, but they will also be more likely to reach the wrong boundary due to noise in the process, leading to more errors." Larger a means more separation between the correct and incorrect response boundaries

t = **non-decision time**: "takes into account the duration of nondecisional processes...such processes may comprise basic encoding processes, the configuration of working memory for a task, and processes of response execution (i.e., motor activity)." (Voss et al., 2013)

Per Allie, larger values of v mean faster accumulation of evidence (faster rate), larger t means slower non-decision time processing, larger a means more separation between the correct and incorrect response boundaries, and z is the distance from the upper boundary to the start of the drift process.

# Get Setup
## Clear everything & set width
```{r echo=FALSE, results='hide', message=FALSE, warning=FALSE}
    options(width=80, Ncpus = 6) #Set width
    rm(list=ls())     #Remove everything from environment
    cat("\014")       #Clear Console
```

## Load Libraries
```{r echo=FALSE, message=FALSE, warning=FALSE}
  # renv::restore()     #restore environment
  library(knitr)      #allows rmarkdown files
  library(haven)      #helps import stata
  library(MASS)       #calculate residualized scores
  library(tidyverse)  #plotting/cleaning, etc.
  library(broom)      #nice statistical output
  library(here)       #nice file paths
  library(expss)      #labeling variables/values
  library(psych)      #used for statistical analyses
  library(labelled)
  library(confintr)
  library(papaja)
  library(DescTools)
  library(irr)
  library(workflowr)  #helps with workflow
  library(lmerTest)
  library(broom.mixed)
  library(ggplot2)

  here()
  set.seed(312)    #Set seed
```

## Function correlation_matrix
```{r}
correlation_matrix <- function(df, 
                               type = "pearson",
                               digits = 3, 
                               decimal.mark = ".",
                               use = "all", 
                               show_significance = TRUE, 
                               replace_diagonal = FALSE, 
                               replacement = ""){
  
  # check arguments
  stopifnot({
    is.numeric(digits)
    digits >= 0
    use %in% c("all", "upper", "lower")
    is.logical(replace_diagonal)
    is.logical(show_significance)
    is.character(replacement)
  })
  # we need the Hmisc package for this
  require(Hmisc)
  
  # retain only numeric and boolean columns
  isNumericOrBoolean = vapply(df, function(x) is.numeric(x) | is.logical(x), logical(1))
  if (sum(!isNumericOrBoolean) > 0) {
    cat('Dropping non-numeric/-boolean column(s):', paste(names(isNumericOrBoolean)[!isNumericOrBoolean], collapse = ', '), '\n\n')
  }
  df = df[isNumericOrBoolean]
  
  # transform input data frame to matrix
  x <- as.matrix(df)
  
  # run correlation analysis using Hmisc package
  correlation_matrix <- Hmisc::rcorr(x, type = )
  R <- correlation_matrix$r # Matrix of correlation coeficients
  p <- correlation_matrix$P # Matrix of p-value 
  
  # transform correlations to specific character format
  Rformatted = formatC(R, format = 'f', digits = digits, decimal.mark = decimal.mark)
  
  # if there are any negative numbers, we want to put a space before the positives to align all
  if (sum(R < 0) > 0) {
    Rformatted = ifelse(R > 0, paste0(' ', Rformatted), Rformatted)
  }
  
  # add significance levels if desired
  if (show_significance) {
    # define notions for significance levels; spacing is important.
    stars <- ifelse(is.na(p), "   ", ifelse(p < .001, "***", ifelse(p < .01, "** ", ifelse(p < .05, "*  ", "   "))))
    Rformatted = paste0(Rformatted, stars)
  }
  # build a new matrix that includes the formatted correlations and their significance stars
  Rnew <- matrix(Rformatted, ncol = ncol(x))
  rownames(Rnew) <- colnames(x)
  colnames(Rnew) <- paste(colnames(x), "", sep =" ")
  
  # replace undesired values
  if (use == 'upper') {
    Rnew[lower.tri(Rnew, diag = replace_diagonal)] <- replacement
  } else if (use == 'lower') {
    Rnew[upper.tri(Rnew, diag = replace_diagonal)] <- replacement
  } else if (replace_diagonal) {
    diag(Rnew) <- replacement
  }
  
  return(Rnew)
}

save_correlation_matrix = function(df, filename, ...) {
  write.csv2(correlation_matrix(df, ...), file = filename)
}
```

## Load Data
Remember to immediately rename and remove. Avoid overwriting old data.
```{r}
LDDM_do1_alt_rdoc <- read.csv(here("../RDoC/DDM_Results/Block_Based/RDoC_Day1_Block11_Alternative_Models.csv"), header=TRUE)

LDDM_do1_rdoc <- read_sav(here("./data/RDoC_ERN_0-80ms_Final.sav"))
LDDM_do1_rdoc$ID <- LDDM_do1_rdoc$SubjectID

LDDM_do2_rdoc <- LDDM_do1_rdoc %>%
  left_join(LDDM_do1_alt_rdoc, by="ID") %>%
  filter(DQ >= 0.5)
  
load(file=here("./data/LDDM_cleaning04_fullbeh_rdoc.RData"))

load(file=here("./data/LDDM_cleaning04_rdoc_calc3.RData"))

## Load Color-Word D-KEFS test (Stroop) data
LDDM_do1_rdoc_iq <- read_sav(here("./data/RDoC_WTAR_FINAL 1.28.2019.sav"))
LDDM_do1_rdoc_iq$ID <- LDDM_do1_rdoc_iq$SubjectID
# lapply(LDDM_do1_rdoc_iq, attr, "label")
LDDM_do1_neuro <- read_sav(here("./data/RDoC_Neuropsych_Cleaning_HL_FINAL_3.19.18.sav"))
LDDM_do1_neuro$ID <- LDDM_do1_neuro$SubjectID

LDDM_do2_neuro <- LDDM_do1_neuro %>%
  left_join(LDDM_do1_rdoc_iq, by="ID")

LDDM_do3_rdoc <- LDDM_do2_rdoc %>%
  left_join(LDDM_cleaning04_rdoc_calc3, by="ID") %>%
  left_join(LDDM_do2_neuro, by="ID")

# LDDM_do3_rdoc_no_outliers <- LDDM_do2_rdoc_no_outliers %>%
  # left_join(LDDM_cleaning04_rdoc_calc3, by="ID")
```

## Make residualized score
```{r}
electrodes_list <- c("Fz","Cz","FCz")

# Calculate residualized ERN and difference score ERN (for verification of direction)
for (ex in electrodes_list[1:3]){
    eval(parse(text=paste0('LDDM_do3_rdoc$',ex,'_ERN_080 <- stdres(lm(',ex,'3chan_error_500_300 ~ ',ex, '3chan_correct_500_300, LDDM_do3_rdoc, na.action=na.exclude))')))
    eval(parse(text=paste0('LDDM_do3_rdoc$',ex,'_ERN_080_diff <- LDDM_do3_rdoc$',ex,'3chan_error_500_300 - LDDM_do3_rdoc$',ex,'3chan_correct_500_300')))
    eval(parse(text=paste0('LDDM_do3_rdoc$',ex,'_ERN_080_diff <- as.numeric(LDDM_do3_rdoc$',ex,'_ERN_080_diff)')))
    eval(parse(text=paste0('LDDM_do3_rdoc$',ex,'_ERN_080 <- as.numeric(LDDM_do3_rdoc$',ex,'_ERN_080)')))
}

LDDM_do3_rdoc$B11_avtz_DO_v_v <- rowMeans(LDDM_do3_rdoc[,c('B11_avtz_DO_v_v_con','B11_avtz_DO_v_v_incon')], na.rm=F)
LDDM_do3_rdoc$B11_avt_DO_v_v <- rowMeans(LDDM_do3_rdoc[,c('B11_avt_DO_v_v_con','B11_avt_DO_v_v_incon')], na.rm=F)
LDDM_do3_rdoc$B11_avtz_DO_v_v <- rowMeans(LDDM_do3_rdoc[,c('B11_avtz_DO_v_v_con','B11_avtz_DO_v_v_incon')], na.rm=F)
```

## Remove outliers
```{r}
LDDM_do3_rdoc_no_outliers <- LDDM_do3_rdoc %>%
  mutate(FCz_ERN_080 = Winsorize(FCz_ERN_080, 
                                    minval=mean(FCz_ERN_080, na.rm=T)-(3*sd(FCz_ERN_080, na.rm=T)),
                                    maxval=mean(FCz_ERN_080, na.rm=T)+(3*sd(FCz_ERN_080, na.rm=T)),
                                    na.rm=T),
         Inhib_time = Winsorize(Inhib_time, 
                                    minval=mean(Inhib_time, na.rm=T)-(3*sd(Inhib_time, na.rm=T)),
                                    maxval=mean(Inhib_time, na.rm=T)+(3*sd(Inhib_time, na.rm=T)),
                                    na.rm=T))
```

## Standardize scores
```{r}
var_list <- c("B11_avtz_DO_v_v","B11_avtz_DO_v_v_con","B11_avtz_DO_v_v_incon","B11_avtz_DO_v_a","B11_avtz_DO_v_t","B11_avtz_DO_v_z",
              "B11_avt_v","B11_avt_a","B11_avt_t",
              "B11_avtz_v","B11_avtz_a","B11_avtz_t","B11_avtz_z",
              "B11_avt_DO_v_v","B11_avt_DO_v_v_con","B11_avt_DO_v_v_incon","B11_avt_DO_v_a", "B11_avt_DO_v_t",
              "B11_avtz_DO_v_v","B11_avtz_DO_v_v_con","B11_avtz_DO_v_v_incon","B11_avtz_DO_v_a","B11_avtz_DO_v_t","B11_avtz_DO_v_z",
              "flanker_score_rdoc",
              "FCz_ERN_080","FCz_ERN_080_diff",
              "Inhib_time","Pred_FSIQ","Motor_time","accuracy")

for (v in var_list){ 
  print(paste0("LDDM_do3_rdoc$",v))
  eval(parse(text=paste0('LDDM_do3_rdoc$',v,'_z <- scale(LDDM_do3_rdoc$',v,', center=T, scale=T)'))) 
}

for (v in var_list){ 
  print(paste0("LDDM_do3_rdoc$",v))
  eval(parse(text=paste0('LDDM_do3_rdoc_no_outliers$',v,'_z <- scale(LDDM_do3_rdoc_no_outliers$',v,', center=T, scale=T)'))) 
}
```


# Correlations
## ERN amplitude & DDM
```{r}
all_measures_rdoc <- c("FCz_ERN_080_z","flanker_score_rdoc_z","accuracy_z",
                  "B11_avtz_DO_v_v_z","B11_avtz_DO_v_v_con_z","B11_avtz_DO_v_v_incon_z","B11_avtz_DO_v_a_z","B11_avtz_DO_v_t_z","B11_avtz_DO_v_z_z")

rdoc_correlations <- correlation_matrix(LDDM_do3_rdoc_no_outliers[c(all_measures_rdoc)], type = c("pearson"), use = 'lower', replace_diagonal=TRUE, replacement="")

write.csv(rdoc_correlations, file="./tables/rdoc_correlations.csv")

# ggplot(filter(LDDM_do3_rdoc,FCz_ERN_080>-3 & FCz_ERN_080<3), aes(x=FCz_ERN_080_z, y=B11_avtz_DO_v_v_z)) +
#   geom_point() +
#   stat_smooth(method="lm")
```

### Alternative models
```{r}
ERN_table_rdoc_alt1 <- data.frame(parameters= c("v", "a", "t"),
                        r= c(corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avt_v_z)$r,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avt_a_z)$r,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avt_t_z)$r),
                        p_nominal = c(corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avt_v_z)$p,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avt_a_z)$p,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avt_t_z)$p)); ERN_table_rdoc_alt1$p_corrected <- p.adjust(ERN_table_rdoc_alt1$p_nominal, method="fdr"); ERN_table_rdoc_alt1[,2:4] <- round(ERN_table_rdoc_alt1[,2:4], 3)

ERN_table_rdoc_alt2 <- data.frame(parameters= c("v", "a", "t", "z"),
                        r= c(corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_v_z)$r,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_a_z)$r,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_t_z)$r,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_z_z)$r),
                        p_nominal = c(corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_v_z)$p,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_a_z)$p,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_t_z)$p,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_z_z)$p)); ERN_table_rdoc_alt2$p_corrected <- p.adjust(ERN_table_rdoc_alt2$p_nominal, method="fdr"); ERN_table_rdoc_alt2[,2:4] <- round(ERN_table_rdoc_alt2[,2:4], 3)

ERN_table_rdoc_alt3 <- data.frame(parameters= c("v_congruent", "v_incongruent", "a", "t"),
                        r= c(corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avt_DO_v_v_con_z)$r,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avt_DO_v_v_incon_z)$r,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avt_DO_v_a_z)$r,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avt_DO_v_t_z)$r),
                        p_nominal = c(corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avt_DO_v_v_con_z)$p,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avt_DO_v_v_incon_z)$p,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avt_DO_v_a_z)$p,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avt_DO_v_t_z)$p)); ERN_table_rdoc_alt3$p_corrected <- p.adjust(ERN_table_rdoc_alt3$p_nominal, method="fdr"); ERN_table_rdoc_alt3[,2:4] <- round(ERN_table_rdoc_alt3[,2:4], 3)

ERN_table_rdoc_alt4 <- data.frame(parameters= c("v_congruent", "v_incongruent", "a", "t", "z"),
                        r= c(corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_DO_v_v_con_z)$r,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_DO_v_v_incon_z)$r,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_DO_v_a_z)$r,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_DO_v_t_z)$r,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_DO_v_z_z)$r),
                        p_nominal = c(corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_DO_v_v_con_z)$p,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_DO_v_v_incon_z)$p,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_DO_v_a_z)$p,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_DO_v_t_z)$p,
                             corr.test(LDDM_do3_rdoc$FCz_ERN_080_z, LDDM_do3_rdoc$B11_avtz_DO_v_z_z)$p)); ERN_table_rdoc_alt4$p_corrected <- p.adjust(ERN_table_rdoc_alt4$p_nominal, method="fdr"); ERN_table_rdoc_alt4[,2:4] <- round(ERN_table_rdoc_alt4[,2:4], 3)

write.csv(t(ERN_table_rdoc_alt1), here("./tables/rdoc_ERN_table_alt1.csv"))
write.csv(t(ERN_table_rdoc_alt2), here("./tables/rdoc_ERN_table_alt2.csv"))
write.csv(t(ERN_table_rdoc_alt3), here("./tables/rdoc_ERN_table_alt3.csv"))
write.csv(t(ERN_table_rdoc_alt4), here("./tables/rdoc_ERN_table_alt4.csv"))
```

#  Multiple regressions
```{r}
make_CI <- function(lower, upper) {
  paste0("[", round(lower,2), ", ", round(upper,2), "]")
}

i=1
mr_ERN_table_rdoc <- as.data.frame(matrix(nrow=6, ncol=4))
mr_ERN_table_rdoc[,1] <- c("Drift rate","Drift rate (congruent)","Drift rate (incongruent)","Threshold","Non-decision time","Starting bias")
mr_ERN_table_rdoc_raw <- as.data.frame(matrix(nrow=6, ncol=4))
mr_ERN_table_rdoc_raw[,1] <- c("Drift rate","Drift rate (congruent)","Drift rate (incongruent)","Threshold","Non-decision time","Starting bias")

for (var in c("B11_avtz_DO_v_v_z","B11_avtz_DO_v_v_con_z","B11_avtz_DO_v_v_incon_z","B11_avtz_DO_v_a_z","B11_avtz_DO_v_t_z","B11_avtz_DO_v_z_z")) {
  eval(parse(text=paste0("
             model <- lmer(FCz_ERN_080_z ~ ",var," + flanker_score_rdoc_z + accuracy_z + (1 | F_ID), LDDM_do3_rdoc_no_outliers)
             
             mr_ERN_table_rdoc[i,2] <- paste0(round(tidy(model)$estimate[2],2), ifelse(tidy(model)$p.value[2]<0.01, '** ', ifelse(tidy(model)$p.value[2]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[4,1], confint(model)[4,2]))
             mr_ERN_table_rdoc[i,3] <- paste0(round(tidy(model)$estimate[3],2), ifelse(tidy(model)$p.value[3]<0.01, '** ', ifelse(tidy(model)$p.value[3]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[5,1], confint(model)[5,2]))
             mr_ERN_table_rdoc[i,4] <- paste0(round(tidy(model)$estimate[4],2), ifelse(tidy(model)$p.value[4]<0.01, '** ', ifelse(tidy(model)$p.value[4]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[6,1], confint(model)[6,2]))

            mr_ERN_table_rdoc_raw[i,2] <- tidy(model)$estimate[2]
            mr_ERN_table_rdoc_raw[i,3] <- confint(model)[4,1]
            mr_ERN_table_rdoc_raw[i,4] <- confint(model)[4,2]
            
            mr_ERN_table_rdoc_raw[i,5] <- tidy(model)$estimate[3]
            mr_ERN_table_rdoc_raw[i,6] <- confint(model)[5,1]
            mr_ERN_table_rdoc_raw[i,7] <- confint(model)[5,2]
            
            mr_ERN_table_rdoc_raw[i,8] <- tidy(model)$estimate[4]
            mr_ERN_table_rdoc_raw[i,9] <- confint(model)[6,1]
            mr_ERN_table_rdoc_raw[i,10] <- confint(model)[6,2]
                                   ")))
  i=i+1
}

colnames(mr_ERN_table_rdoc) <- c("Parameters","Drift rate", "NIH Toolbox", "Raw accuracy")

write.csv(mr_ERN_table_rdoc, here("./tables/mr_ERN_table_rdoc.csv"))
write.csv(mr_ERN_table_rdoc_raw, here("./tables/mr_ERN_table_rdoc_raw.csv"))
```


# Convergence with neuropsych measures
## Inhibition & DDM 
```{r}
LDDM_do3_rdoc_no_outliers$NL_time_rev <- -1*LDDM_do3_rdoc_no_outliers$NL_time
LDDM_do3_rdoc_no_outliers$Inhib_time_rev <- -1*LDDM_do3_rdoc_no_outliers$Inhib_time
LDDM_do3_rdoc_no_outliers$Inhib_time_rev_z <- scale(LDDM_do3_rdoc_no_outliers$Inhib_time_rev, center=T, scale=T)

i=1
mr_INHIB_table_rdoc_nocov <- as.data.frame(matrix(nrow=6, ncol=4))
mr_INHIB_table_rdoc_nocov[,1] <- c("Drift rate","Drift rate (congruent)","Drift rate (incongruent)","Threshold","Non-decision time","Starting bias")

mr_INHIB_table_rdoc_cov <- as.data.frame(matrix(nrow=6, ncol=4))
mr_INHIB_table_rdoc_cov[,1] <- c("Drift rate","Drift rate (congruent)","Drift rate (incongruent)","Threshold","Non-decision time","Starting bias")
mr_INHIB_table_rdoc_cov_raw <- as.data.frame(matrix(nrow=6, ncol=4))
mr_INHIB_table_rdoc_cov_raw[,1] <- c("Drift rate","Drift rate (congruent)","Drift rate (incongruent)","Threshold","Non-decision time","Starting bias")

for (var in c("B11_avtz_DO_v_v_z","B11_avtz_DO_v_v_con_z","B11_avtz_DO_v_v_incon_z","B11_avtz_DO_v_a_z","B11_avtz_DO_v_t_z","B11_avtz_DO_v_z_z")) {
  eval(parse(text=paste0("
             model <- lmer(Inhib_time_rev_z ~ ",var," + flanker_score_rdoc_z + accuracy_z + (1 | F_ID), LDDM_do3_rdoc_no_outliers)
             
             mr_INHIB_table_rdoc_nocov[i,2] <- paste0(round(tidy(model)$estimate[2],2), ifelse(tidy(model)$p.value[2]<0.01, '** ', ifelse(tidy(model)$p.value[2]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[4,1], confint(model)[4,2]))
             mr_INHIB_table_rdoc_nocov[i,3] <- paste0(round(tidy(model)$estimate[3],2), ifelse(tidy(model)$p.value[3]<0.01, '** ', ifelse(tidy(model)$p.value[3]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[5,1], confint(model)[5,2]))
             mr_INHIB_table_rdoc_nocov[i,4] <- paste0(round(tidy(model)$estimate[4],2), ifelse(tidy(model)$p.value[4]<0.01, '** ', ifelse(tidy(model)$p.value[4]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[6,1], confint(model)[6,2]))
            
             model_cov <- lmer(Inhib_time_rev_z ~ ",var," + flanker_score_rdoc_z + accuracy_z + Pred_FSIQ + Motor_time + (1 | F_ID), LDDM_do3_rdoc_no_outliers)
             
             mr_INHIB_table_rdoc_cov[i,2] <- paste0(round(tidy(model_cov)$estimate[2],2), ifelse(tidy(model_cov)$p.value[2]<0.01, '** ', ifelse(tidy(model_cov)$p.value[2]<0.05, '* ', ' ')), 
                                            make_CI(confint(model_cov)[4,1], confint(model_cov)[4,2]))
             mr_INHIB_table_rdoc_cov[i,3] <- paste0(round(tidy(model_cov)$estimate[3],2), ifelse(tidy(model_cov)$p.value[3]<0.01, '** ', ifelse(tidy(model_cov)$p.value[3]<0.05, '* ', ' ')), 
                                            make_CI(confint(model_cov)[5,1], confint(model_cov)[5,2]))
             mr_INHIB_table_rdoc_cov[i,4] <- paste0(round(tidy(model_cov)$estimate[4],2), ifelse(tidy(model_cov)$p.value[4]<0.01, '** ', ifelse(tidy(model_cov)$p.value[4]<0.05, '* ', ' ')), 
                                            make_CI(confint(model_cov)[6,1], confint(model_cov)[6,2]))
                                            
            mr_INHIB_table_rdoc_cov_raw[i,2] <- tidy(model_cov)$estimate[2]
            mr_INHIB_table_rdoc_cov_raw[i,3] <- confint(model_cov)[4,1]
            mr_INHIB_table_rdoc_cov_raw[i,4] <- confint(model_cov)[4,2]
            
            mr_INHIB_table_rdoc_cov_raw[i,5] <- tidy(model_cov)$estimate[3]
            mr_INHIB_table_rdoc_cov_raw[i,6] <- confint(model_cov)[5,1]
            mr_INHIB_table_rdoc_cov_raw[i,7] <- confint(model_cov)[5,2]
            
            mr_INHIB_table_rdoc_cov_raw[i,8] <- tidy(model_cov)$estimate[4]
            mr_INHIB_table_rdoc_cov_raw[i,9] <- confint(model_cov)[6,1]
            mr_INHIB_table_rdoc_cov_raw[i,10] <- confint(model_cov)[6,2]
                                   ")))
  i=i+1
}

colnames(mr_INHIB_table_rdoc_nocov) <- c("Parameters","Drift rate", "NIH Toolbox", "Raw accuracy")
colnames(mr_INHIB_table_rdoc_cov) <- c("Parameters","Drift rate", "NIH Toolbox", "Raw accuracy")

write.csv(mr_INHIB_table_rdoc_nocov, here("./tables/mr_INHIB_table_rdoc_nocov.csv"))
write.csv(mr_INHIB_table_rdoc_cov, here("./tables/mr_INHIB_table_rdoc_cov.csv"))
write.csv(mr_INHIB_table_rdoc_cov_raw, here("./tables/mr_INHIB_table_rdoc_cov_raw.csv"))
```

## Executive functioning & DDM 
```{r}
# lapply(LDDM_do3_rdoc, attr, "label")
LDDM_do3_rdoc_no_outliers$NL_time_rev <- -1*LDDM_do3_rdoc_no_outliers$NL_time
LDDM_do3_rdoc_no_outliers$Inhib_time_rev <- -1*LDDM_do3_rdoc_no_outliers$Inhib_time

LDDM_do3_rdoc_no_outliers$exec_composite <- rowMeans(LDDM_do3_rdoc_no_outliers[,c("FF_cor","Switch_cor","NL_time_rev","Inhib_time_rev")], na.rm=F)
LDDM_do3_rdoc_no_outliers$exec_composite_z <- scale(LDDM_do3_rdoc_no_outliers$exec_composite, center=T, scale=T)

i=1
mr_EXEC_table_rdoc_nocov <- as.data.frame(matrix(nrow=6, ncol=4))
mr_EXEC_table_rdoc_nocov[,1] <- c("Drift rate","Drift rate (congruent)","Drift rate (incongruent)","Threshold","Non-decision time","Starting bias")

mr_EXEC_table_rdoc_cov <- as.data.frame(matrix(nrow=6, ncol=4))
mr_EXEC_table_rdoc_cov[,1] <- c("Drift rate","Drift rate (congruent)","Drift rate (incongruent)","Threshold","Non-decision time","Starting bias")
mr_EXEC_table_rdoc_cov_raw <- as.data.frame(matrix(nrow=6, ncol=4))
mr_EXEC_table_rdoc_cov_raw[,1] <- c("Drift rate","Drift rate (congruent)","Drift rate (incongruent)","Threshold","Non-decision time","Starting bias")

for (var in c("B11_avtz_DO_v_v_z","B11_avtz_DO_v_v_con_z","B11_avtz_DO_v_v_incon_z","B11_avtz_DO_v_a_z","B11_avtz_DO_v_t_z","B11_avtz_DO_v_z_z")) {
  eval(parse(text=paste0("
             model <- lmer(exec_composite_z ~ ",var," + flanker_score_rdoc_z + accuracy_z + (1 | F_ID), LDDM_do3_rdoc_no_outliers)
             
             mr_EXEC_table_rdoc_nocov[i,2] <- paste0(round(tidy(model)$estimate[2],2), ifelse(tidy(model)$p.value[2]<0.01, '** ', ifelse(tidy(model)$p.value[2]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[4,1], confint(model)[4,2]))
             mr_EXEC_table_rdoc_nocov[i,3] <- paste0(round(tidy(model)$estimate[3],2), ifelse(tidy(model)$p.value[3]<0.01, '** ', ifelse(tidy(model)$p.value[3]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[5,1], confint(model)[5,2]))
             mr_EXEC_table_rdoc_nocov[i,4] <- paste0(round(tidy(model)$estimate[4],2), ifelse(tidy(model)$p.value[4]<0.01, '** ', ifelse(tidy(model)$p.value[4]<0.05, '* ', ' ')), 
                                            make_CI(confint(model)[6,1], confint(model)[6,2]))
            
             model_cov <- lmer(exec_composite_z ~ ",var," + flanker_score_rdoc_z + accuracy_z + Pred_FSIQ + Motor_time + (1 | F_ID), LDDM_do3_rdoc_no_outliers)
             
             mr_EXEC_table_rdoc_cov[i,2] <- paste0(round(tidy(model_cov)$estimate[2],2), ifelse(tidy(model_cov)$p.value[2]<0.01, '** ', ifelse(tidy(model_cov)$p.value[2]<0.05, '* ', ' ')), 
                                            make_CI(confint(model_cov)[4,1], confint(model_cov)[4,2]))
             mr_EXEC_table_rdoc_cov[i,3] <- paste0(round(tidy(model_cov)$estimate[3],2), ifelse(tidy(model_cov)$p.value[3]<0.01, '** ', ifelse(tidy(model_cov)$p.value[3]<0.05, '* ', ' ')), 
                                            make_CI(confint(model_cov)[5,1], confint(model_cov)[5,2]))
             mr_EXEC_table_rdoc_cov[i,4] <- paste0(round(tidy(model_cov)$estimate[4],2), ifelse(tidy(model_cov)$p.value[4]<0.01, '** ', ifelse(tidy(model_cov)$p.value[4]<0.05, '* ', ' ')), 
                                            make_CI(confint(model_cov)[6,1], confint(model_cov)[6,2]))
                                            
            mr_EXEC_table_rdoc_cov_raw[i,2] <- tidy(model_cov)$estimate[2]
            mr_EXEC_table_rdoc_cov_raw[i,3] <- confint(model_cov)[4,1]
            mr_EXEC_table_rdoc_cov_raw[i,4] <- confint(model_cov)[4,2]
            
            mr_EXEC_table_rdoc_cov_raw[i,5] <- tidy(model_cov)$estimate[3]
            mr_EXEC_table_rdoc_cov_raw[i,6] <- confint(model_cov)[5,1]
            mr_EXEC_table_rdoc_cov_raw[i,7] <- confint(model_cov)[5,2]
            
            mr_EXEC_table_rdoc_cov_raw[i,8] <- tidy(model_cov)$estimate[4]
            mr_EXEC_table_rdoc_cov_raw[i,9] <- confint(model_cov)[6,1]
            mr_EXEC_table_rdoc_cov_raw[i,10] <- confint(model_cov)[6,2]
                                   ")))
  i=i+1
}

colnames(mr_EXEC_table_rdoc_nocov) <- c("Parameters","Drift rate", "NIH Toolbox", "Raw accuracy")
colnames(mr_EXEC_table_rdoc_cov) <- c("Parameters","Drift rate", "NIH Toolbox", "Raw accuracy")

write.csv(mr_EXEC_table_rdoc_nocov, here("./tables/mr_Exec_table_rdoc_nocov.csv"))
write.csv(mr_EXEC_table_rdoc_cov, here("./tables/mr_Exec_table_rdoc_cov.csv"))
write.csv(mr_EXEC_table_rdoc_cov_raw, here("./tables/mr_EXEC_table_rdoc_cov_raw.csv"))
```

# Heritability
```{r}
LDDM_do3_rdoc_sib <- LDDM_do3_rdoc %>%
  pivot_wider(id_cols=F_ID, names_from=S_ID, 
              values_from=c(B11_avtz_DO_v_v_z, B11_avtz_DO_v_v_con_z, B11_avtz_DO_v_v_incon_z,
                            B11_avtz_DO_v_a_z,B11_avtz_DO_v_t_z,B11_avtz_DO_v_z_z,flanker_score_rdoc_z,accuracy_z))

LDDM_heritability_table <- data.frame(parameters= c("v", "v_congruent", "v_incongruent", "a", "t", "z", "nihtoolbox_flanker", "accuracy"),
                           ICC=c(icc(LDDM_do3_rdoc_sib[c("B11_avtz_DO_v_v_z_1","B11_avtz_DO_v_v_z_2")])$value,
                           icc(LDDM_do3_rdoc_sib[c("B11_avtz_DO_v_v_con_z_1","B11_avtz_DO_v_v_con_z_2")])$value,
                           icc(LDDM_do3_rdoc_sib[c("B11_avtz_DO_v_v_incon_z_1","B11_avtz_DO_v_v_incon_z_2")])$value,
                           icc(LDDM_do3_rdoc_sib[c("B11_avtz_DO_v_a_z_1","B11_avtz_DO_v_a_z_2")])$value,
                           icc(LDDM_do3_rdoc_sib[c("B11_avtz_DO_v_t_z_1","B11_avtz_DO_v_t_z_2")])$value,
                           icc(LDDM_do3_rdoc_sib[c("B11_avtz_DO_v_z_z_1","B11_avtz_DO_v_z_z_2")])$value,
                           icc(LDDM_do3_rdoc_sib[c("flanker_score_rdoc_z_1","flanker_score_rdoc_z_2")])$value,
                           icc(LDDM_do3_rdoc_sib[c("accuracy_z_1","accuracy_z_2")])$value),
                           p=c(icc(LDDM_do3_rdoc_sib[c("B11_avtz_DO_v_v_z_1","B11_avtz_DO_v_v_z_2")])$p.value,
                           icc(LDDM_do3_rdoc_sib[c("B11_avtz_DO_v_v_con_z_1","B11_avtz_DO_v_v_con_z_2")])$p.value,
                           icc(LDDM_do3_rdoc_sib[c("B11_avtz_DO_v_v_incon_z_1","B11_avtz_DO_v_v_incon_z_2")])$p.value,
                           icc(LDDM_do3_rdoc_sib[c("B11_avtz_DO_v_a_z_1","B11_avtz_DO_v_a_z_2")])$p.value,
                           icc(LDDM_do3_rdoc_sib[c("B11_avtz_DO_v_t_z_1","B11_avtz_DO_v_t_z_2")])$p.value,
                           icc(LDDM_do3_rdoc_sib[c("B11_avtz_DO_v_z_z_1","B11_avtz_DO_v_z_z_2")])$p.value,
                           icc(LDDM_do3_rdoc_sib[c("flanker_score_rdoc_z_1","flanker_score_rdoc_z_2")])$p.value,
                           icc(LDDM_do3_rdoc_sib[c("accuracy_z_1","accuracy_z_2")])$p.value))

write.csv(LDDM_heritability_table, "./tables/rdoc_heritability_table.csv")
```

# Split half reliability (Spearman-Brown prophecy)
```{r}
load(file=here("./data/LDDM_cleaning04_fullbeh_rdoc.RData"))

LDDM_cleaning04_rdoc_reliability <- LDDM_cleaning04_fullbeh_rdoc %>%
  group_by(subj_idx) %>%
  mutate(block = c(rep(1,30),rep(2,30),rep(3,30),rep(4,30),rep(5,30),rep(6,30),rep(7,30),rep(8,30),rep(9,30),rep(10,30),rep(11,30))) %>%
  group_by(subj_idx) %>%
  mutate(trial = 1:330)

for (s in seq(15,166,15)){
    eval(parse(text=paste0('
LDDM_first',s,'_1 <- LDDM_cleaning04_rdoc_reliability %>% filter(trial<=',s,')
LDDM_second',s,'_1 <- LDDM_cleaning04_rdoc_reliability %>% filter(trial< ',(s*2)+1,' & trial>',s,')
  
LDDM_first',s,'_2 <- LDDM_first',s,'_1 %>%
  group_by(subj_idx) %>% # per subject
  summarise(accuracy_score = sum(response==1)*(5/length(trial))) # accuracy score per NIH TOoolbox manual
LDDM_second',s,'_2 <- LDDM_second',s,'_1 %>%
  group_by(subj_idx) %>%
  summarise(accuracy_score = sum(response==1)*(5/length(trial))) # accuracy score per NIH TOoolbox manual

LDDM_first',s,'_3 <-  LDDM_first',s,'_1 %>%
  group_by(subj_idx) %>% # per subject
  filter(stim=="incongruent" & response==1) %>% # incongruent trials with correct response
  mutate(mean_rt = mean(rt),
         sd_rt = sd(rt)) %>% # compute individual mean and sd RT for use below
  filter(rt>=0.1 & rt>(mean_rt - 3*sd_rt) & rt<(mean_rt + 3*sd_rt)) %>% # remove trials less than 100ms and less than 3SD below or 3SD above the mean RT
  summarise(med_rt = median(rt)*1000) %>% # compute individual level median RT
  mutate(rt_score = 5-(5*((log(med_rt)-log(250))/(log(1000)-log(250))))) # compute RT score to go into flanker score
LDDM_second',s,'_3 <-  LDDM_second',s,'_1 %>%
  group_by(subj_idx) %>% # per subject
  filter(stim=="incongruent" & response==1) %>% # incongruent trials with correct response
  mutate(mean_rt = mean(rt),
         sd_rt = sd(rt)) %>% # compute individual mean and sd RT for use below
  filter(rt>=0.1 & rt>(mean_rt - 3*sd_rt) & rt<(mean_rt + 3*sd_rt)) %>% # remove trials less than 100ms and less than 3SD below or 3SD above the mean RT
  summarise(med_rt = median(rt)*1000) %>% # compute individual level median RT
  mutate(rt_score = 5-(5*((log(med_rt)-log(250))/(log(1000)-log(250))))) # compute RT score to go into flanker score

LDDM_first',s,' <- LDDM_first',s,'_1 %>%
  full_join(LDDM_first',s,'_2, by = "subj_idx") %>%
  full_join(LDDM_first',s,'_3, by="subj_idx") %>%
  group_by(subj_idx) %>% # per subject
  mutate(total_accuracy_perc = sum(response==1)/length(response)) %>% # compute total accuracy percentage
  summarise(flanker_score_list_rdoc = if_else(total_accuracy_perc>=0.8, accuracy_score+rt_score, accuracy_score),
            accuracy = mean(total_accuracy_perc)) %>% # if accuracy is above 80% then add accuracy and rt flanker scores, if not base the flanker score only on accuracy; also compute a regular percentage based accuracy (ie percent of trials when subject was correct)
  transmute(ID=subj_idx, flanker_score_list_rdoc=flanker_score_list_rdoc, accuracy=accuracy) %>%
  group_by(ID) %>% # per subject
  summarise(flanker_score_rdoc = mean(flanker_score_list_rdoc),
            accuracy = mean(accuracy))
LDDM_second',s,' <- LDDM_second',s,'_1 %>%
  full_join(LDDM_second',s,'_2, by = "subj_idx") %>%
  full_join(LDDM_second',s,'_3, by="subj_idx") %>%
  group_by(subj_idx) %>% # per subject
  mutate(total_accuracy_perc = sum(response==1)/length(response)) %>% # compute total accuracy percentage
  summarise(flanker_score_list_rdoc = if_else(total_accuracy_perc>=0.8, accuracy_score+rt_score, accuracy_score),
            accuracy = mean(total_accuracy_perc)) %>% # if accuracy is above 80% then add accuracy and rt flanker scores, if not base the flanker score only on accuracy; also compute a regular percentage based accuracy (ie percent of trials when subject was correct)
  transmute(ID=subj_idx, flanker_score_list_rdoc=flanker_score_list_rdoc, accuracy=accuracy) %>%
  group_by(ID) %>% # per subject
  summarise(flanker_score_rdoc = mean(flanker_score_list_rdoc),
            accuracy = mean(accuracy))
            
r_half_',s,' <- cor(LDDM_first',s,'$flanker_score_rdoc, LDDM_second',s,'$flanker_score_rdoc, use="pairwise")
r_half_ci_',s,' <- ci_cor(LDDM_first',s,'$flanker_score_rdoc, LDDM_second',s,'$flanker_score_rdoc, use="pairwise")
r_sb_ci_lower_',s,' <- (2*r_half_ci_',s,'$interval[1])/(1+r_half_ci_',s,'$interval[1])
r_sb_ci_upper_',s,' <- (2*r_half_ci_',s,'$interval[2])/(1+r_half_ci_',s,'$interval[2])
r_sb_',s,' <- (2*r_half_',s,')/(1+r_half_',s,')

r_acc_half_',s,' <- cor(LDDM_first',s,'$accuracy, LDDM_second',s,'$accuracy, use="pairwise")
r_acc_half_ci_',s,' <- ci_cor(LDDM_first',s,'$accuracy, LDDM_second',s,'$accuracy, use="pairwise")
r_acc_sb_ci_lower_',s,' <- (2*r_acc_half_ci_',s,'$interval[1])/(1+r_acc_half_ci_',s,'$interval[1])
r_acc_sb_ci_upper_',s,' <- (2*r_acc_half_ci_',s,'$interval[2])/(1+r_acc_half_ci_',s,'$interval[2])
r_acc_sb_',s,' <- (2*r_acc_half_',s,')/(1+r_acc_half_',s,')

')))
}

spearman_brown_rdoc <- data.frame(trials=seq(15,165,15),
                             r=rep(NA,length(seq(15,165,15))),
                             r_ci_lower=rep(NA,length(seq(15,165,15))),
                             r_ci_upper=rep(NA,length(seq(15,165,15))),
                             r_acc=rep(NA,length(seq(15,165,15))),
                             r_acc_ci_lower=rep(NA,length(seq(15,165,15))),
                             r_acc_ci_upper=rep(NA,length(seq(15,165,15))))
i=1
for (s in seq(15,165,15)){
  eval(parse(text=paste0('spearman_brown_rdoc[i,2] <- round(as.numeric(r_sb_',s,'),3)
                         spearman_brown_rdoc[i,3] <- round(as.numeric(r_sb_ci_lower_',s,'),3)
                         spearman_brown_rdoc[i,4] <- round(as.numeric(r_sb_ci_upper_',s,'),3)
                         spearman_brown_rdoc[i,5] <- round(as.numeric(r_acc_sb_',s,'),3)
                         spearman_brown_rdoc[i,6] <- round(as.numeric(r_acc_sb_ci_lower_',s,'),3)
                         spearman_brown_rdoc[i,7] <- round(as.numeric(r_acc_sb_ci_upper_',s,'),3)')))
  i=i+1
}
# spearman_brown_rdoc
# 
# ggplot(spearman_brown_rdoc, aes(x=trials, y=r, group=1)) +
#   geom_line() +
#   geom_point() +
#   scale_y_continuous(limits = c(0, 1)) +
#   geom_ribbon(aes(ymin = r_ci_lower, ymax = r_ci_upper), alpha = 0.2)
```

# SOBP Stats
```{r}
sum(!is.na(LDDM_do3_rdoc_no_outliers$B11_avtz_DO_v_v_z))

summary(lmer(FCz_ERN_080_z ~ B11_avtz_DO_v_v_con_z + flanker_score_rdoc_z + accuracy_z + (1 | F_ID), LDDM_do3_rdoc_no_outliers))
summary(lmer(FCz_ERN_080_z ~ B11_avtz_DO_v_v_incon_z + flanker_score_rdoc_z + accuracy_z + (1 | F_ID), LDDM_do3_rdoc_no_outliers))

summary(lmer(FCz_ERN_080_z ~ B11_avtz_DO_v_v_z + (1 | F_ID), LDDM_do3_rdoc_no_outliers))
```

# Save datasets
```{r}
save(LDDM_do3_rdoc, file="./data/LDDM_do3_rdoc.RData")
save(LDDM_do3_rdoc_no_outliers, file="./data/LDDM_do3_rdoc_no_outliers.RData")
save(spearman_brown_rdoc, file="./data/spearman_brown_rdoc.RData")
```

