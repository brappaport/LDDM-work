---
title: "Data prep script 2: Importing ERP data"
author: "Brent Rappaport"
date: "`r format(Sys.time(),  '%Y-%m-%d')`"
output:
  pdf_document: default
  html_document:
    df_print: paged
subtitle: Template Rmd
editor_options:
  chunk_output_type: console
toc: yes
---

# About
This script imports and merges the self-report data from the Flanker task of the State-Trait study

# 1. Get Setup
## 1.1. Clear everything & set width
```{r echo=TRUE, results='hide', message=FALSE}
    options(width=80, Ncpus = 6) #Set width
    rm(list=ls())     #Remove everything from environment
    cat("\014")       #Clear Console
```

## 1.2. Load Libraries
```{r echo=TRUE, results='hide', message=FALSE}
  renv::restore()     #restore environment
  library(knitr)      #allows rmarkdown files
  library(haven)      #helps import stata
  library(questionr)  #allows lookfor function
  library(tidyverse)  #plotting/cleaning, etc.
  library(broom)      #nice statistical output
  library(here)       #nice file paths
  library(expss)      #labeling variables/values
  library(psych)      #used for statistical analyses
  library(workflowr)  #helps with workflow
```

## 1.3. Get the Working Directory
```{r}
  here()
```

## 1.4. Set seed
```{r}
     set.seed(312)    #Set seed
```

## 1.5 Load Data
Remember to immediately rename and remove. Avoid overwriting old data.
```{r}
load("./data/LDDM_cleaning02_s1.RData")
LDDM_cleaning02_s1$ID <- LDDM_cleaning02_s1$subj_idx

LDDM_cleaning02_frac_prak_latency <- read.csv("/Volumes/fsmresfiles/PBS/Stewarts/State Trait Study/current_studies/Letkiewicz_DDM/eeg_processing/erppath/frac_peak_latency_p3_200800.csv")[,1:14]
LDDM_cleaning02_frac_prak_latency <- LDDM_cleaning02_frac_prak_latency %>% 
  rename_with(~paste0(., "_fpl"), contains("bin"))

LDDM_cleaning02_mean_amplitude_ERN_CRN_080 <- read.csv("/Volumes/fsmresfiles/PBS/Stewarts/State Trait Study/current_studies/Letkiewicz_DDM/eeg_processing/erppath/mean_amplitude_ERN_CRN_080.csv")[,1:14]
LDDM_cleaning02_mean_amplitude_ERN_CRN_080 <- LDDM_cleaning02_mean_amplitude_ERN_CRN_080 %>% 
  rename_with(~paste0(., "_080"), contains("bin"))

LDDM_cleaning02_mean_amplitude_ERN_CRN_0100 <- read.csv("/Volumes/fsmresfiles/PBS/Stewarts/State Trait Study/current_studies/Letkiewicz_DDM/eeg_processing/erppath/mean_amplitude_ERN_CRN_0100.csv")[,1:14]
LDDM_cleaning02_mean_amplitude_ERN_CRN_0100 <- LDDM_cleaning02_mean_amplitude_ERN_CRN_0100 %>% 
  rename_with(~paste0(., "_0100"), contains("bin"))

LDDM_cleaning02_erp <- LDDM_cleaning02_frac_prak_latency %>%  
  left_join(LDDM_cleaning02_mean_amplitude_ERN_CRN_080, by=c('ID','Session')) %>%
  left_join(LDDM_cleaning02_mean_amplitude_ERN_CRN_0100, by=c('ID','Session'))

LDDM_cleaning02 <- LDDM_cleaning02_s1 %>%
  left_join(LDDM_cleaning02_erp, by='ID')

save(LDDM_cleaning02, file="./data/LDDM_cleaning02.RData")
```

# 2. Create residualized scores
```{r}
electrodes_list <- c("Fz","Cz","FCz","CPz","Pz","POz")
ern_condition_list <- c("correct","error")

for (ex in electrodes_list[1:3]){ 
  for (con in ern_condition_list){
    for (day in 1:5){
  eval(parse(text=paste0("LDDM_cleaning02$",ex,"_",con,"_d",day," <- ifelse(LDDM_cleaning02$ERN_Qual_D",day,"==1, LDDM_cleaning02$",ex,"_",con,"_0_80_s",day,", NA)"))) 
    }
  }
}

for (day in 1:5){ 
  for (ex in electrodes_list[1:3]){ 
    eval(parse(text=paste0("LDDM_cleaning02$",ex,"_ERN_d",day," <- stdres(lm(",ex,"_error_d",day," ~ ",ex,"_correct_d",day,", LDDM_cleaning02, na.action=na.exclude))"))) 
  }
  print(eval(parse(text=paste0("sum(!is.na(LDDM_cleaning02$Fz_ERN_d",day,"))"))))
}
```

# 3. Closing out
  In this step, go ahead and close out of the file and quit R without saving  
  the work space.
```{r}
   renv::snapshot()   #Take a snapshot of environment
```

