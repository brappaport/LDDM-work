---
title             : "Psychometrics of drift-diffusion model parameters derived from the Eriksen flanker task: Reliability and validity in two independent samples"
shorttitle        : "Psychometrics of DDM"
author: 
  - name          : "Brent I. Rappaport, Allison M. Letkiewicz, Savannah Buchanan, Anna Weinberg, Stewart A. Shankman"

header-includes:
  - \usepackage{setspace}
  - \AtBeginEnvironment{tabular}{\singlespacing}
  - \AtBeginEnvironment{lltable}{\singlespacing}
  - \addtolength{\tabcolsep}{-5pt}
  - \AtBeginEnvironment{tablenotes}{\doublespacing}
  - \captionsetup[table]{font={stretch=1.5}}
  - \captionsetup[figure]{font={stretch=1.5}}
  
floatsintext      : yes
linenumbers       : no
draft             : no
mask              : no
figurelist        : yes
tablelist         : yes
footnotelist      : no
documentclass     : "apa7"
classoption       : "man"
output            : papaja::apa6_pdf
geometry          : "left=3cm,right=3cm,top=2cm,bottom=2cm"
---

```{r echo=FALSE, results='hide', message=FALSE, echo=FALSE, ,warning=FALSE, error=FALSE}
    options(width=80, Ncpus = 6, mc.cores=6) #Set width
    rm(list=ls())     #Remove everything from environment
    cat("\014")       #Clear Console

  library(knitr)      #allows rmarkdown files
  library(haven)      #helps import stata
  library(MASS)       #calculate residualized scores
  library(tidyverse)  #plotting/cleaning, etc.
  library(broom)      #nice statistical output
  library(expss)      #labeling variables/values
  library(psych)      #used for statistical analyses
  library(labelled)   #get labelled values when importing from SPSS
  library(confintr)   #get confidence intervals from models
  library(papaja)     #APA formatting
  library(DescTools)  #descriptive statistics
  library(irr)        #ICC
  library(lmerTest)   #p value from mixed effects models
  library(broom.mixed) #tidying output of mixed effects models
  library(ggplot2)    #plotting graphs
  library(ggpubr)
  library(scales)
  library(forcats)
  library(scipub)
  library(here)       #nice file paths
  library(workflowr)  #helps with workflow

r_refs("LDDM.bib")
```

```{r analysis-preferences, set.seed(312), echo=FALSE, results='hide', message=FALSE, echo=FALSE, ,warning=FALSE, error=FALSE}
# Seed for random number generation
set.seed(312)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed)
```

```{r Load data}
here::i_am("./manuscript/LDDM_tables_and_figures.Rmd")
load(file=here("./data/LDDM_do2_d1_not_outliers.RData"))
load(file=here("./data/LDDM_do2_d2_not_outliers.RData"))
load(file=here("./data/LDDM_do2_d3_not_outliers.RData"))

load(file=here("./data/LDDM_cleaning04_calc3_1to3.RData"))
load(file=here("./data/LDDM_do2_irr.RData"))
load(file=here("./data/LDDM_do2.RData"))
load(file=here("./data/spearman_brown_d1.RData"))
load(file=here("./data/spearman_brown_d2.RData"))
load(file=here("./data/spearman_brown_d3.RData"))

load(file=here("./data/LDDM_do3_rdoc.RData"))
load(file=here("./data/LDDM_do3_rdoc_no_outliers.RData"))
load(file=here("./data/spearman_brown_rdoc.RData"))
```

```{r}
 correlation_matrix <- function(df, 
                                type = "spearman",
                                digits = 3, 
                                decimal.mark = ".",
                                use = "all", 
                                show_significance = TRUE, 
                                replace_diagonal = FALSE, 
                                replacement = ""){
   
   # check arguments
   stopifnot({
     is.numeric(digits)
     digits >= 0
     use %in% c("all", "upper", "lower")
     is.logical(replace_diagonal)
     is.logical(show_significance)
     is.character(replacement)
   })
   # we need the Hmisc package for this
   require(Hmisc)
   
   # retain only numeric and boolean columns
   isNumericOrBoolean = vapply(df, function(x) is.numeric(x) | is.logical(x), logical(1))
   if (sum(!isNumericOrBoolean) > 0) {
     cat('Dropping non-numeric/-boolean column(s):', paste(names(isNumericOrBoolean)[!isNumericOrBoolean], collapse = ', '), '\n\n')
   }
   df = df[isNumericOrBoolean]
   
   # transform input data frame to matrix
   x <- as.matrix(df)
   
   # run correlation analysis using Hmisc package
   correlation_matrix <- Hmisc::rcorr(x, type = "spearman")
   R <- correlation_matrix$r # Matrix of correlation coeficients
   p <- correlation_matrix$P # Matrix of p-value 
   
   # transform correlations to specific character format
   Rformatted = formatC(R, format = 'f', digits = digits, decimal.mark = decimal.mark)
   
   # if there are any negative numbers, we want to put a space before the positives to align all
   if (sum(R < 0) > 0) {
     Rformatted = ifelse(R > 0, paste0(' ', Rformatted), Rformatted)
   }
   
   # add significance levels if desired
   if (show_significance) {
     # define notions for significance levels; spacing is important.
     stars <- ifelse(is.na(p), "   ", ifelse(p < .01, "** ", ifelse(p < .05, "*  ", "   ")))
     Rformatted = paste0(Rformatted, stars)
   }
   # build a new matrix that includes the formatted correlations and their significance stars
   Rnew <- matrix(Rformatted, ncol = ncol(x))
   rownames(Rnew) <- colnames(x)
   colnames(Rnew) <- paste(colnames(x), "", sep =" ")
   
   # replace undesired values
   if (use == 'upper') {
     Rnew[lower.tri(Rnew, diag = replace_diagonal)] <- replacement
   } else if (use == 'lower') {
     Rnew[upper.tri(Rnew, diag = replace_diagonal)] <- replacement
   } else if (replace_diagonal) {
     diag(Rnew) <- replacement
   }
   
   return(Rnew)
 }

 save_correlation_matrix = function(df, filename, ...) {
   write.csv2(correlation_matrix(df, ...), file = filename)
 }
```

```{r}
make_CI <- function(lower, upper) {
  paste0("[", round(lower,2), ", ", round(upper,2), "]")
}

group.colors <- c(`Drift rate` = "#469990", `Drift rate (congruent)` = "#911eb4", `Drift rate (incongruent)` ="#000075", `Boundary separation` = "#3cb44b", `NIH Toolbox` = "#f58231", `Accuracy (incongruent)` = "#e6194B")
```

```{r warning=FALSE}
load(file=here("./data/LDDM_cleaning02_demo.RData"))
LDDM_do2_d1_demo <- full_join(LDDM_do2_d1_not_outliers, LDDM_cleaning02_demo)
LDDM_do2_d1_demo$Gender <- case_match(LDDM_do2_d1_demo$Gender, 1~"Male", 2~"Female")

LDDM_do3_rdoc_no_outliers$exec_composite_pos <- -1*LDDM_do3_rdoc_no_outliers$exec_composite
LDDM_do3_rdoc_no_outliers$Gender <- case_match(LDDM_do3_rdoc_no_outliers$Gender, 1~"Male", 2~"Female")
demo_rdoc <- FullTable1(vars=c("Gender","Age","accuracy","accuracy_congruent","accuracy_incongruent","flanker_score_rdoc","Pred_FSIQ","Inhib_time","exec_composite_pos"), 
                        var_names=c("Gender","Age","Raw accuracy","Accuracy (congruent)","Accuracy (incongruent)",
                                    "NIH Toolbox score","IQ","Inhibition","Set-shifting"),
                        data=filter(LDDM_do3_rdoc_no_outliers, complete.cases(accuracy)))

demo_d1 <- FullTable1(vars=c("Gender","Age","accuracy","accuracy_congruent","accuracy_incongruent","flanker_score"),
                      var_names=c("Gender","Age","Overall accuracy","Accuracy (congruent)","Accuracy (incongruent)",
                                    "NIH Toolbox score"),
                      data=filter(LDDM_do2_d1_demo, complete.cases(accuracy)))
demo_d2 <- FullTable1(vars=c("accuracy","accuracy_congruent","accuracy_incongruent","flanker_score"),
                      var_names=c("Overall accuracy","Accuracy (congruent)","Accuracy (incongruent)",
                                    "NIH Toolbox score"),
                      data=filter(LDDM_do2_d2_not_outliers, complete.cases(accuracy)))
demo_d3 <- FullTable1(vars=c("accuracy","accuracy_congruent","accuracy_incongruent","flanker_score"),
                      var_names=c("Overall accuracy","Accuracy (congruent)","Accuracy (incongruent)",
                                    "NIH Toolbox score"),
                      data=filter(LDDM_do2_d3_not_outliers, complete.cases(accuracy)))

full_demo <- data.frame("Variable"= c(demo_rdoc$table[,1]),
                        "Study1"= c(demo_rdoc$table[,2]),
                        "Session1"= c(demo_d1$table[,2],"--","--","--"),
                        "Session2"= c("--","--",demo_d2$table[,2],"--","--", "--"),
                        "Session3"= c("--","--",demo_d3$table[,2],"--","--", "--"))

# demo_rdoc$caption
# demo_d1$caption
```
```{r}
# Print the demographic table
apa_table(full_demo,
          caption="Demographics of two study samples",
          note="Means (SD) for continuous variables, N (%) for dichotomous variables. Study 1: N=5 missing age, N=47 missing gender, N=13 missing IQ, N=15 missing inhibition, N=28 missing shifting. Study 2: N=8 missing Age.",
          col_spanners = list(`Variables` = c(1,1),`Study 1` = c(2,2), `Study 2` = c(3,5)),
          col.names = c("", "", "Session 1", "Session 2", "Session 3"),
          align = c("l", rep("c", 4))
)
```

```{r schematic, fig.cap = "Depiction drift-diffusion modeling of flanker behavioral data.", out.width='100%'}
# Include the image of the DDM modeling that Allie made
knitr::include_graphics('../figures/LDDM_figure1.png')
```

```{r Correlation tables}
all_measures_sttr <- c("FCZ_ERN_080_d1_z","flanker_score_d1_z","accuracy_incongruent_d1_z",
                   "v_S1_B11_d1_z","v_congruent_S1_B11_d1_z","v_incongruent_S1_B11_d1_z","a_S1_B11_d1_z",
                   "FCZ_ERN_080_d2_z","flanker_score_d2_z","accuracy_incongruent_d2_z",
                   "v_S2_B11_d2_z","v_congruent_S2_B11_d2_z","v_incongruent_S2_B11_d2_z","a_S2_B11_d2_z",
                   "FCZ_ERN_080_d3_z","flanker_score_d3_z","accuracy_incongruent_d3_z",
                   "v_S3_B11_d3_z","v_congruent_S3_B11_d3_z","v_incongruent_S3_B11_d3_z","a_S3_B11_d3_z")

all_measures_rdoc <- c("FCz_ERN_080_z","flanker_score_rdoc_z","accuracy_incongruent_z",
                   "B11_avtz_DO_v_v_z","B11_avtz_DO_v_v_con_z","B11_avtz_DO_v_v_incon_z","B11_avtz_DO_v_a_z","Inhib_time_z","exec_composite_z")

# Merge all STTR datasets together
LDDM_do2_sttr_not_outliers <- full_join(LDDM_do2_d1_not_outliers, LDDM_do2_d2_not_outliers, by="id.x") %>%
   full_join(LDDM_do2_d3_not_outliers, by="id.x")

# Make correlation matrices for STTR and RDOC
sttr_correlations <- correlation_matrix(LDDM_do2_sttr_not_outliers[c(all_measures_sttr)], type = c("spearman"), use = 'lower', replace_diagonal=TRUE, replacement="")
rdoc_correlations <- correlation_matrix(LDDM_do3_rdoc_no_outliers[c(all_measures_rdoc)], type = c("spearman"), use = 'lower', replace_diagonal=TRUE, replacement="")

# For STTR, specify variables in each Session
`Session 1` <- 1:7
`Session 2` <- 8:14
`Session 3` <- 15:21
table_list <- list(`Session 1`, `Session 2`, `Session 3`)

# Set all missing values to be empty
sttr_correlations[is.na(sttr_correlations)] <- ""
sttr_correlations[is.na(rdoc_correlations)] <- ""

# Rename all columns and rows for STTR and RDOC correlation matrices
# colnames(sttr_correlations)=rep(c("ERN","NIH","Acc",
#                    "DR","DR (co)","Drift rate (incon)","BS"),3)
sttr_correlations <-  as.data.frame(sttr_correlations) %>%
  mutate(measures=rep(c("ERN","NIH","Acc","DR","DR (con)","DR (incon)","BS"),3)) %>%
  select(measures, everything())
 
# colnames(rdoc_correlations)=rep(c("ERN","NIH","Acc",
#                    "DR","DR (co)","Drift rate (incon)","BS","Inhibition","SS"),1)
rownames(rdoc_correlations)=rep(c("ERN","NIH","Acc",
                   "DR","DR (con)","DR (incon)","BS","Inhibition","SS"),1)

# Make the actual tables
apa_table(rdoc_correlations,
           # added_stub_head=c("Session 1", "Session 2", "Session 3"),
           # stub_indents=table_list,
           row.names=TRUE,
           align = c("p{2.6cm}", rep("p{1.6cm}", ncol(rdoc_correlations)-1)),
           col.names=c("Measures","ERN","NIH","Acc",
                   "DR","DR con","DR incon","BS","Inhibition","SS"),
           font_size="footnotesize",
           caption = "Bivariate spearman correlations among Study 1 variables",
           note = "** p < .01, * p < .05. ERN: error-related negativity, NIH: NIH Toolbox, Acc: raw accuracy (incongruent), DR: drift rate, BS: boundary separation, con: congruent trials, incon: incongruent trials, SS: set-shifting.",
           landscape=TRUE
)
  
apa_table(sttr_correlations,
           row.names=FALSE,
           align = c("p{1.7cm}", rep("p{1cm}", ncol(sttr_correlations)-1)),
           col.names=c("Measures",rep(c("ERN","NIH","Acc",
                   "DR","DR con","DR incon","BS"),3)),
           font_size="tiny",
           col_spanners = list(` ` = c(1,1),`Session 1` = c(2,8), `Session 2` = c(9,15), `Session 3` = c(16,22)),
           caption = "Bivariate spearman correlations among Study 2 variables",
           note = "** p < .01, * p < .05. ERN: error-related negativity, NIH: NIH Toolbox, Acc: raw accuracy (incongruent), DR: drift rate, BS: boundary separation, con: congruent trials, incon: incongruent trials.",
           stub_indents=list(`Session 1`=c(1:7), `Session 2`=c(8:14), `Session 3`=c(15:21)),
           landscape=TRUE
)

```

```{r Split-half, warning=FALSE}
splithalf <- read.csv(here("./tables/splithalf.csv"))
splithalf_d1 <- read.csv(here("./../Split_Half/StTr_S1_splithalf_all_mean_ci.csv"))
splithalf_d2 <- read.csv(here("./../Split_Half/StTr_S2_splithalf_all_mean_ci.csv"))
splithalf_d3 <- read.csv(here("./../Split_Half/StTr_S3_splithalf_all_mean_ci.csv"))
splithalf_rdoc <- read.csv(here("./../Split_Half/RDoC_splithalf_all_rev_mean_ci.csv"))

make_splithalf_datatable <- function (df) {
  data.frame(trials=seq(15,165,15),
                             rv=rowMeans(df[,c("avtz_DO_v_df_vcon","avtz_DO_v_df_vinc")]),
                             rv_cilower=rowMeans(df[,c("avtz_DO_v_df_v_con_ci_lower","avtz_DO_v_df_v_inc_ci_lower")]),
                             rv_ciupper=rowMeans(df[,c("avtz_DO_v_df_v_con_ci_upper","avtz_DO_v_df_v_inc_ci_upper")]),
                             ra=df$avtz_DO_v_df_a,
                             ra_cilower=df$avtz_DO_v_df_a_ci_lower,
                             ra_ciupper=df$avtz_DO_v_df_a_ci_upper)
}

spearman_brown_d1_ddm <- make_splithalf_datatable(splithalf_d1)
spearman_brown_d2_ddm <- make_splithalf_datatable(splithalf_d2)
spearman_brown_d3_ddm <- make_splithalf_datatable(splithalf_d3)
spearman_brown_rdoc_ddm <- make_splithalf_datatable(splithalf_rdoc)

# splithalf[6,] <- c("NIH Toolbox score", spearman_brown_d1[11,2], spearman_brown_d2[11,2], spearman_brown_d3[11,2], spearman_brown_rdoc[11,2])
# splithalf[7,] <- c("Raw accuracy", spearman_brown_d1[11,5], spearman_brown_d2[11,5], spearman_brown_d3[11,5], spearman_brown_rdoc[11,5])
# splithalf[,1] <- c("Drift rate to congruent stimuli", "Drift rate to incongruent stimuli", "Boundary separation", "Non-decision time", "Starting bias", "NIH Toolbox score", "Raw accuracy")
# # splithalf <- round(splithalf[6:7,2:5], 2)
# 
# write.csv(splithalf, file=here("./tables/splithalf_full.csv"))

# apa_table(splithalf,
#           col.names=c("DDM paramters","Session 1","Session 2","Session 3", "Study 1"),
#           align = c("l", rep("c", 4)),
#           digits=2,
#           caption = "Table 2",
#           note = "",
#           col_spanners=list(`Study 2`=c(2,4)))

spearman_brown_d1_plot <- spearman_brown_d1 %>%
  full_join(spearman_brown_d1_ddm, by = "trials") %>%
  select(-c("rdriftcon","rdriftincon","rboundary_separation")) %>%
  pivot_longer(-c(trials), names_to="Measure") %>%
  separate(Measure, "_", into = c("Measure", "Stat")) %>%
  pivot_wider(names_from=Stat, values_from=value) %>%
  mutate(r=`NA`) %>%
  select(-c(`NA`))

spearman_brown_d1_plot$Measure_long <- recode_factor(spearman_brown_d1_plot$Measure, rv = "Drift rate", ra = "Boundary separation", rnih = "NIH Toolbox", racc = "Accuracy (incongruent)")
                                               
sh_d1 <- ggplot(spearman_brown_d1_plot, aes(x=trials*2, y=r, fill=Measure_long)) +
  geom_line(aes(color=Measure_long)) +
  geom_point(aes(color=Measure_long)) +
  geom_ribbon(aes(ymin = cilower, ymax = ciupper, fill=Measure_long), alpha = 0.1) +
  scale_x_continuous(breaks=spearman_brown_d1$trials*2) +
  scale_y_continuous(limits = c(-0.3, 1), breaks=seq(0,1,by=0.10)) +
  scale_color_manual(name="Measure", values=group.colors,
                    labels=c(str_wrap("Drift rate", 10), str_wrap("Boundary separation",10),
                             str_wrap("NIH Toolbox",10), str_wrap("Accuracy (incongruent)",10))) +
  scale_fill_manual(guide=NULL, values=group.colors) +
  theme_apa() +
  theme(legend.position="top")

spearman_brown_d2_plot <- spearman_brown_d2 %>%
  full_join(spearman_brown_d2_ddm, by = "trials") %>%
  select(-c("rdriftcon","rboundary_separation")) %>%
  pivot_longer(-c(trials), names_to="Measure") %>%
  separate(Measure, "_", into = c("Measure", "Stat")) %>%
  pivot_wider(names_from=Stat, values_from=value) %>%
  mutate(r=`NA`) %>%
  select(-c(`NA`))

spearman_brown_d2_plot$Measure_long <- recode_factor(spearman_brown_d2_plot$Measure, rv = "Drift rate", ra = "Boundary separation", rnih = "NIH Toolbox", racc = "Accuracy (incongruent)")

sh_d2 <- ggplot(spearman_brown_d2_plot, aes(x=trials*2, y=r, fill=Measure_long)) +
  geom_line(aes(color=Measure_long)) +
  geom_point(aes(color=Measure_long)) +
  geom_ribbon(aes(ymin = cilower, ymax = ciupper, fill=Measure_long), alpha = 0.1) +
  scale_x_continuous(breaks=spearman_brown_d2$trials*2) +
  scale_y_continuous(limits = c(-0.3, 1), breaks=seq(0,1,by=0.10)) +
  scale_color_manual(name="Measure", values=group.colors,
                    labels=c(str_wrap("Drift rate", 10), str_wrap("Boundary separation",10),
                             str_wrap("NIH Toolbox",10), str_wrap("Accuracy (incongruent)",10))) +
  scale_fill_manual(guide=NULL, values=group.colors) +
  theme_apa() +
  theme(legend.position="top")

spearman_brown_d3_plot <- spearman_brown_d3 %>%
  full_join(spearman_brown_d3_ddm, by = "trials") %>%
  select(-c("rdriftcon","rboundary_separation")) %>%
  pivot_longer(-c(trials), names_to="Measure") %>%
  separate(Measure, "_", into = c("Measure", "Stat")) %>%
  pivot_wider(names_from=Stat, values_from=value) %>%
  mutate(r=`NA`) %>%
  select(-c(`NA`))

spearman_brown_d3_plot$Measure_long <- recode_factor(spearman_brown_d3_plot$Measure, rv = "Drift rate", ra = "Boundary separation", rnih = "NIH Toolbox", racc = "Accuracy (incongruent)")

sh_d3 <- ggplot(spearman_brown_d3_plot, aes(x=trials*2, y=r, fill=Measure_long)) +
  geom_line(aes(color=Measure_long)) +
  geom_point(aes(color=Measure_long)) +
  geom_ribbon(aes(ymin = cilower, ymax = ciupper, fill=Measure_long), alpha = 0.1) +
  scale_x_continuous(breaks=spearman_brown_d3$trials*2) +
  scale_y_continuous(limits = c(-0.3, 1), breaks=seq(0,1,by=0.10)) +
  scale_color_manual(name="Measure", values=group.colors,
                    labels=c(str_wrap("Drift rate", 10), str_wrap("Boundary separation",10),
                             str_wrap("NIH Toolbox",10), str_wrap("Accuracy (incongruent)",10))) +
  scale_fill_manual(guide=NULL, values=group.colors) +
  theme_apa() +
  theme(legend.position="top")

spearman_brown_rdoc_plot <- spearman_brown_rdoc %>%
  full_join(spearman_brown_rdoc_ddm, by = "trials") %>%
  select(-c("rdriftcon","rdriftincon","rboundary_separation")) %>%
  pivot_longer(-c(trials), names_to="Measure") %>%
  separate(Measure, "_", into = c("Measure", "Stat")) %>%
  pivot_wider(names_from=Stat, values_from=value) %>%
  mutate(r=`NA`) %>%
  select(-c(`NA`))

spearman_brown_rdoc_plot$Measure_long <- recode_factor(spearman_brown_rdoc_plot$Measure, rv = "Drift rate", ra = "Boundary separation", rnih = "NIH Toolbox", racc = "Accuracy (incongruent)")

sh_rdoc <- ggplot(spearman_brown_rdoc_plot, aes(x=trials*2, y=r)) +
  geom_line(aes(color=Measure_long)) +
  geom_point(aes(color=Measure_long)) +
  geom_ribbon(aes(ymin = cilower, ymax = ciupper, fill=Measure_long), alpha = 0.1) +
  scale_x_continuous(breaks=spearman_brown_rdoc$trials*2) +
  scale_y_continuous(limits = c(-0.3, 1), breaks=seq(0,1,by=0.10)) +
  scale_color_manual(name="Measure", values=group.colors,
                    labels=c(str_wrap("Drift rate", 10), str_wrap("Boundary separation",10),
                             str_wrap("NIH Toolbox",10), str_wrap("Accuracy (incongruent)",10))) +
  scale_fill_manual(guide=NULL, values=group.colors) +
  theme_apa() +
  theme(legend.position="bottom")
```

\newpage
\begin{landscape}
```{r, fig.cap = "Spearman-Brown split-half reliability with increasing trials across Study 1 and all three sessions of Study 2.", out.width='1\\linewidth', fig.width=10, fig.height=8}
sh <- ggarrange(sh_rdoc + rremove("xylab") + rremove("x.text") + rremove("legend"),
          sh_d1 + rremove("xylab") + rremove("x.text") + rremove("legend"),
          sh_d2 + rremove("xylab") + rremove("legend"),
          sh_d3 + rremove("xylab") + rremove("legend"),
          labels=c("Study 1","Study 2: Session 1","Study 2: Session 2","Study 2: Session 3"),
          # label.x = 0.5,
          # label.y = 1,
          hjust=c(-1, -0.5, -0.5, -0.5),
          common.legend = TRUE,
          align="hv",
          legend="top",
          ncol=2, nrow=2,
          heights = c(1, 1, 1, 1))

sh <- annotate_figure(sh, left = grid::textGrob("Spearman-Brown split-half [95% CI]", rot = 90, vjust = 1, gp = grid::gpar(cex = 1.3)),
                bottom = grid::textGrob("Number of total trials", gp = grid::gpar(cex = 1.3)),
                fig.lab.size=12)
sh
```
\end{landscape}


```{r Test-retest}
sttr_hddm_variables <- c("v_S1_B11","v_S2_B11","v_S3_B11",
                         "v_congruent_S1_B11.x","v_congruent_S2_B11.x","v_congruent_S3_B11.x",
                         "v_incongruent_S1_B11.x","v_incongruent_S2_B11.x","v_incongruent_S3_B11.x",
                         "a_S1_B11.x","a_S2_B11.x","a_S3_B11.x",
                         "t_S1_B11.x","t_S2_B11.x","t_S3_B11.x",
                         "z_S1_B11.x","z_S2_B11.x","z_S3_B11.x",
                         "flanker_score_d1_z","flanker_score_d2_z","flanker_score_d3_z",
                         "accuracy_d1_z","accuracy_d2_z","accuracy_d3_z",
                         "accuracy_incongruent_d1_z","accuracy_incongruent_d2_z","accuracy_incongruent_d3_z")

sttr_icc_table <- data.frame(
                           parameters= c("Drift rate", "Drift rate (congruent)", "Drift rate (incongruent)", "Boundary separation", "Non-decision time", "Starting bias", "NIH Toolbox", "Accuracy (incongruent)"),
                                 
                           ICC=c(icc(LDDM_do2_irr[sttr_hddm_variables[1:3]])$value,
                           icc(LDDM_do2_irr[sttr_hddm_variables[4:6]])$value,
                           icc(LDDM_do2_irr[sttr_hddm_variables[7:9]])$value,
                           icc(LDDM_do2_irr[sttr_hddm_variables[10:12]])$value,
                           icc(LDDM_do2_irr[sttr_hddm_variables[13:15]])$value,
                           icc(LDDM_do2_irr[sttr_hddm_variables[16:18]])$value,
                           icc(LDDM_do2_irr[sttr_hddm_variables[19:21]])$value,
                           icc(LDDM_do2_irr[sttr_hddm_variables[25:27]])$value),
                           
                           CI=c(make_CI(icc(LDDM_do2_irr[sttr_hddm_variables[1:3]])$lbound,icc(LDDM_do2_irr[sttr_hddm_variables[1:3]])$ubound),
                           make_CI(icc(LDDM_do2_irr[sttr_hddm_variables[4:6]])$lbound,icc(LDDM_do2_irr[sttr_hddm_variables[4:6]])$ubound),
                           make_CI(icc(LDDM_do2_irr[sttr_hddm_variables[7:9]])$lbound,icc(LDDM_do2_irr[sttr_hddm_variables[7:9]])$ubound),
                           make_CI(icc(LDDM_do2_irr[sttr_hddm_variables[10:12]])$lbound,icc(LDDM_do2_irr[sttr_hddm_variables[10:12]])$ubound),
                           make_CI(icc(LDDM_do2_irr[sttr_hddm_variables[13:15]])$lbound,icc(LDDM_do2_irr[sttr_hddm_variables[13:15]])$ubound),
                           make_CI(icc(LDDM_do2_irr[sttr_hddm_variables[16:18]])$lbound,icc(LDDM_do2_irr[sttr_hddm_variables[16:18]])$ubound),
                           make_CI(icc(LDDM_do2_irr[sttr_hddm_variables[19:21]])$lbound,icc(LDDM_do2_irr[sttr_hddm_variables[19:21]])$ubound),
                           make_CI(icc(LDDM_do2_irr[sttr_hddm_variables[25:27]])$lbound,icc(LDDM_do2_irr[sttr_hddm_variables[25:27]])$ubound)),
                           
                           lower_ci=c(icc(LDDM_do2_irr[sttr_hddm_variables[1:3]])$lbound,
                           icc(LDDM_do2_irr[sttr_hddm_variables[4:6]])$lbound,
                           icc(LDDM_do2_irr[sttr_hddm_variables[7:9]])$lbound,
                           icc(LDDM_do2_irr[sttr_hddm_variables[10:12]])$lbound,
                           icc(LDDM_do2_irr[sttr_hddm_variables[13:15]])$lbound,
                           icc(LDDM_do2_irr[sttr_hddm_variables[16:18]])$lbound,
                           icc(LDDM_do2_irr[sttr_hddm_variables[19:21]])$lbound,
                           icc(LDDM_do2_irr[sttr_hddm_variables[25:27]])$lbound),

                           upper_ci=c(icc(LDDM_do2_irr[sttr_hddm_variables[1:3]])$ubound,
                           icc(LDDM_do2_irr[sttr_hddm_variables[4:6]])$ubound,
                           icc(LDDM_do2_irr[sttr_hddm_variables[7:9]])$ubound,
                           icc(LDDM_do2_irr[sttr_hddm_variables[10:12]])$ubound,
                           icc(LDDM_do2_irr[sttr_hddm_variables[13:15]])$ubound,
                           icc(LDDM_do2_irr[sttr_hddm_variables[16:18]])$ubound,
                           icc(LDDM_do2_irr[sttr_hddm_variables[19:21]])$ubound,
                           icc(LDDM_do2_irr[sttr_hddm_variables[25:27]])$ubound)
                           )

sttr_icc_table$ICC <- round(sttr_icc_table$ICC, 2)
write.csv(sttr_icc_table, here("./tables/sttr_icc_table.csv"))
```

```{r fig.cap = "Test-retest reliability of traditional behavioral measures and DDM parameters of interest across three sessions.", out.width='100%'}
sttr_icc_table$parameters <- fct_rev(factor(sttr_icc_table$parameters, levels = sttr_icc_table$parameters))

ggplot(sttr_icc_table[c(1,4,7:8),], aes(y=parameters, x=ICC, color=parameters)) +
  geom_point() +
  geom_text(aes(label=ICC),vjust=-0.75)+
  geom_errorbar(aes(xmin=lower_ci, xmax=upper_ci), colour="black", width=.1) +
  scale_x_continuous(limits = c(0,1), breaks=seq(0,1,0.1)) +
  scale_y_discrete(labels = label_wrap(10)) +
  labs(y="DDM parameters/Measures", x="ICC (95% CI)") +
  scale_color_manual(values=group.colors) +
  # scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  theme_apa() +
  theme(legend.position="none")
```


```{r Multiple regression RDoC table}
mr_ERN_table_rdoc <- read.csv(file=here("./tables/mr_ERN_table_rdoc.csv"))

mr_table_names <- c("X","parameters", "ddm_est", "ddm_lci", "ddm_uci",
                                                 "nih_est", "nih_lci", "nih_uci",
                                                 "acc_est", "acc_lci", "acc_uci")

# RDoC Study
mr_ERN_table_rdoc_raw <- read.csv(file=here("./tables/mr_ERN_table_rdoc_raw.csv"))
colnames(mr_ERN_table_rdoc_raw) <- mr_table_names
mr_ERN_table_rdoc_raw_new <- mr_ERN_table_rdoc_raw %>%
  select(-X) %>%
  pivot_longer(cols=ddm_est:acc_uci, names_to=c("measure","stat"), names_sep="_") %>%
  pivot_wider(names_from=stat, values_from=value)

fit_rdoc <- lmer(FCz_ERN_080 ~ B11_avtz_DO_v_v + flanker_score_rdoc_z + accuracy_incongruent_z + (1 | F_ID), LDDM_do3_rdoc_no_outliers)
# ggplot(LDDM_do3_rdoc_no_outliers, aes(x = B11_avtz_DO_v_v, y = FCz_ERN_080)) +
#   labs(x="ERN mean ampitude (ÂµV)",y="Drift rate")+
#   geom_point(shape = 16, size=1.8) +
#   geom_abline(aes(intercept=`(Intercept)`, slope=B11_avtz_DO_v_v), as.data.frame(t(fixef(fit_rdoc)))) +
#   theme_apa()

mr_ERN_table_rdoc_raw_new <- mr_ERN_table_rdoc_raw_new %>%
  mutate(measure_new = ifelse(measure=="ddm", parameters, ifelse(measure=="nih", "NIH Toolbox", ifelse(measure=="acc", "Accuracy (incongruent)", NA)))) %>%
  mutate(measure_new = factor(measure_new, levels=c("NIH Toolbox", "Accuracy (incongruent)", "Drift rate","Boundary separation")))

# New facet label names for supp variable
param.labs <- c("Model 1", "Model 2")
names(param.labs) <- c("Drift rate", "Boundary separation")

ern_rdoc <- ggplot(mr_ERN_table_rdoc_raw_new[c(1:3, 10:12),], aes(x=est, label=parameters, y=measure_new, color=measure_new)) +
  geom_point(position=position_dodge(width = 1), stat = "identity") +
  geom_errorbar(aes(xmin=lci, xmax=uci), width=.1,  position=position_dodge(width = 1), stat="identity") +
  geom_vline(xintercept = 0) +
  labs(y="DDM model parameter", x="beta [95% CI]", title="ERN") +
  scale_color_manual(values=group.colors) +
  facet_grid(parameters~., scales = "free", space = "fixed", labeller = as_labeller(
    c(`Boundary separation` = "Model 2", 
      `Drift rate` = "Model 1"))) +
  theme_apa() +
  theme(strip.background = element_blank(), #remove background for facet labels
        strip.text.y = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA), #add black border
        panel.spacing = unit(0, "lines"), #remove space between facets)
        legend.position = "none") #hide legend
```

```{r Multiple regression SS tables}
# mr_Inhib_table_rdoc_nocov <- read.csv(file=here("./tables/mr_INHIB_table_rdoc_nocov.csv"))
mr_Inhib_table_rdoc_cov <- read.csv(file=here("./tables/mr_INHIB_table_rdoc_cov.csv"))

mr_Inhib_table_rdoc_cov_raw <- read.csv(file=here("./tables/mr_INHIB_table_rdoc_cov_raw.csv"))
colnames(mr_Inhib_table_rdoc_cov_raw) <- mr_table_names
mr_Inhib_table_rdoc_cov_raw_new <- mr_Inhib_table_rdoc_cov_raw %>%
  select(-X) %>%
  pivot_longer(cols=ddm_est:acc_uci, names_to=c("measure","stat"), names_sep="_") %>%
  pivot_wider(names_from=stat, values_from=value)

mr_Inhib_table_rdoc_cov_raw_new <- mr_Inhib_table_rdoc_cov_raw_new %>%
  mutate(measure_new = ifelse(measure=="ddm", parameters, ifelse(measure=="nih", "NIH Toolbox", ifelse(measure=="acc", "Accuracy (incongruent)", NA)))) %>%
  mutate(measure_new = factor(measure_new, levels=c("NIH Toolbox", "Accuracy (incongruent)", "Drift rate","Boundary separation")))

inh <- ggplot(mr_Inhib_table_rdoc_cov_raw_new[c(1:3, 10:12),], aes(x=est, label=parameters, y=measure_new, color=measure_new)) +
  geom_point(position=position_dodge(width = 1), stat = "identity") +
  geom_errorbar(aes(xmin=lci, xmax=uci), width=.1,  position=position_dodge(width = 1), stat="identity") +
  geom_vline(xintercept = 0) +
  labs(y="DDM model parameter", x="beta [95% CI]", title="Inhibition") +
  scale_color_manual(values=group.colors) +
  facet_grid(parameters~., scales = "free", space = "fixed", labeller = as_labeller(
    c(`Boundary separation` = "Model 2", 
      `Drift rate` = "Model 1"))) +
  theme_apa() +
  theme(strip.background = element_blank(), #remove background for facet labels
        strip.text.y = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA), #add black border
        panel.spacing = unit(0, "lines"), #remove space between facets)
        legend.position = "none") #hide legend

# mr_Exec_table_rdoc_nocov <- read.csv(file=here("./tables/mr_Exec_table_rdoc_nocov.csv"))
mr_Exec_table_rdoc_cov <- read.csv(file=here("./tables/mr_Exec_table_rdoc_cov.csv"))

mr_Exec_table_rdoc_cov_raw <- read.csv(file=here("./tables/mr_Exec_table_rdoc_cov_raw.csv"))
colnames(mr_Exec_table_rdoc_cov_raw) <- mr_table_names
mr_Exec_table_rdoc_cov_raw_new <- mr_Exec_table_rdoc_cov_raw %>%
  select(-X) %>%
  pivot_longer(cols=ddm_est:acc_uci, names_to=c("measure","stat"), names_sep="_") %>%
  pivot_wider(names_from=stat, values_from=value)

mr_Exec_table_rdoc_cov_raw_new <- mr_Exec_table_rdoc_cov_raw_new %>%
  mutate(measure_new = ifelse(measure=="ddm", parameters, ifelse(measure=="nih", "NIH Toolbox", ifelse(measure=="acc", "Accuracy (incongruent)", NA)))) %>%
  mutate(measure_new = factor(measure_new, levels=c("NIH Toolbox", "Accuracy (incongruent)", "Drift rate","Boundary separation")))

model_names <- list(
  'Boundary separation'="Model 2",
  'Drift rate'="Model 1"
)

ss <- ggplot(mr_Exec_table_rdoc_cov_raw_new[c(1:3, 10:12),], aes(x=est, label=parameters, y=measure_new, color=measure_new)) +
  geom_point(position=position_dodge(width = 1), stat = "identity") +
  geom_errorbar(aes(xmin=lci, xmax=uci), width=.1,  position=position_dodge(width = 1), stat="identity") +
  geom_vline(xintercept = 0) +
  labs(y="DDM model parameter", x="beta [95% CI]", title="Set-shifting") +
  scale_color_manual(values=group.colors) +
  facet_grid(parameters~., scales = "free", space = "fixed", labeller = as_labeller(
    c(`Boundary separation` = "Model 2", 
      `Drift rate` = "Model 1"))) +
  theme_apa() +
  theme(strip.background = element_blank(), #remove background for facet labels
        panel.border = element_rect(colour = "black", fill = NA), #add black border
        panel.spacing = unit(0, "lines"), #remove space between facets)
        legend.position = "none") #hide legend
```
\newpage
\begin{landscape}
```{r, fig.cap = "Multiple regression of behavioral measures predicting ERN and neuropsychological tests of inhibition and set-shifting Note: The bivariate correlation between accuracy and inhibition is non-significant (r(376) = -0.05, p=0.35`), suggesting presence of a suppression effect.", out.width='1\\linewidth', fig.width=10, fig.height=8}

val_rdoc <- ggarrange(ern_rdoc + rremove("xylab"),
                      inh + rremove("xylab") + rremove("y.text") + rremove("y.ticks"),
          ss + rremove("xylab") + rremove("y.text") + rremove("y.ticks"),
          ncol=3, nrow=1,
          widths = c(1.6, .9, 1))

val_rdoc <- annotate_figure(val_rdoc, left = grid::textGrob("DDM model parameter", rot = 90, vjust = 1, gp = grid::gpar(cex = 1.3)),
                bottom = grid::textGrob("beta [95% CI]", gp = grid::gpar(cex = 1.3)),
                fig.lab.size=12)
val_rdoc
```
\end{landscape}

```{r}
inh_acc_cor <- corr.test(LDDM_do3_rdoc_no_outliers$Inhib_time_z, LDDM_do3_rdoc_no_outliers$accuracy_incongruent_z, method="spearman")
exec_acc_cor <- corr.test(LDDM_do3_rdoc_no_outliers$exec_composite_z, LDDM_do3_rdoc_no_outliers$accuracy_incongruent_z, method="spearman")
```

```{r For Poster, eval=FALSE}
# Split-half plot
sh_rdoc <- ggplot(spearman_brown_rdoc_plot, aes(x=trials*2, y=r)) +
  geom_line(aes(color=Measure_long), linewidth=2) +
  geom_point(aes(color=Measure_long), size=4) +
  geom_ribbon(aes(ymin = cilower, ymax = ciupper, fill=Measure_long), alpha = 0.1) +
  labs(y = "Spearman-Brown split-/nhalf [95% CI]",
       x = "Number of total trials") +
  scale_x_continuous(breaks=spearman_brown_rdoc$trials*2) +
  scale_y_continuous(limits = c(0, 1), breaks=seq(0,1,by=0.10)) +
  scale_color_manual(name="Measure", values=group.colors,
                    labels=c(str_wrap("Drift rate", 10), str_wrap("Boundary separation",10),
                             str_wrap("NIH Toolbox",10), str_wrap("Accuracy (incongruent)",10))) +
  scale_fill_manual(guide=NULL, values=group.colors) +
  theme_apa() +
  theme(legend.position="none",
        text=element_text(size=40))

ggsave(here("./../presentations/SOBP_2023/splithalf.png"), sh_rdoc, device="png", width=17.5, height=10)

# Test-retest plot
group.colors <- c(`Drift rate` = "#469990", `Drift rate (congruent)` = "#911eb4", `Drift rate (incongruent)` ="#000075", `Boundary separation` = "#3cb44b", `NIH Toolbox` = "#f58231", `Accuracy (incongruent)` = "#e6194B")

test_retest_plot <- ggplot(sttr_icc_table[c(1:4,7:8),], aes(y=parameters, x=ICC, color=parameters)) +
  geom_point(size=4) +
  geom_text(aes(label=ICC),vjust=-0.75, size=10)+
  geom_errorbar(aes(xmin=lower_ci, xmax=upper_ci), colour="black", width=.1, linewidth=1) +
  scale_x_continuous(limits = c(0.2, 1), breaks=seq(0,1,0.1)) +
  scale_y_discrete(labels = label_wrap(20)) +
  labs(y=" ", x="ICC (95% CI)") +
  scale_color_manual(values=group.colors) +
  # scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  theme_apa() +
  theme(legend.position="none",
        text=element_text(size=40))

ggsave(here("./../presentations/SOBP_2023/test_retest_plot.png"), test_retest_plot, device="png", width=17.5, height=10)

# Validity plot
group.colors <- c(`Drift \nrate` = "#469990", `Drift rate (congruent)` = "#911eb4", `Drift rate (incongruent)` ="#000075", `Boundary \nseparation` = "#3cb44b", `NIH \nToolbox` = "#f58231", `Accuracy \n(incongruent)` = "#e6194B")

mr_ERN_table_rdoc_raw_plot <- mr_ERN_table_rdoc_raw_new %>%
  mutate(measure_new = ifelse(measure=="nih", "NIH \nToolbox", 
                                     ifelse(measure=="acc", "Accuracy \n(incongruent)",
                                            ifelse(parameters=="Drift rate", "Drift \nrate",
                                            ifelse(parameters=="Boundary separation", "Boundary \nseparation", NA))))) %>%
  mutate(measure_new = factor(measure_new, levels=c("NIH \nToolbox", "Accuracy \n(incongruent)", "Drift \nrate","Boundary \nseparation")))

ern_rdoc <- ggplot(mr_ERN_table_rdoc_raw_plot[c(1:3, 10:12),], aes(x=est, label=parameters, y=measure_new, color=measure_new)) +
  geom_point(position=position_dodge(width = 1), stat = "identity", size=4) +
  geom_errorbar(aes(xmin=lci, xmax=uci), width=.15,  position=position_dodge(width = 1), stat="identity", linewidth=2) +
  geom_vline(xintercept = 0) +
  labs(y="DDM model parameter", x="beta [95% CI]", title="ERN") +
  scale_x_continuous(breaks=seq(-0.3, 0.3, 0.3)) +
  scale_color_manual(values=group.colors) +
  facet_grid(parameters~., scales = "free", space = "fixed", labeller = as_labeller(
    c(`Boundary separation` = "Model 2", 
      `Drift rate` = "Model 1"))) +
  theme_apa() +
  theme(strip.background = element_blank(), #remove background for facet labels
        strip.text.y = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA), #add black border
        panel.spacing = unit(0, "lines"), #remove space between facets)
        legend.position="none",
        text=element_text(size=30))

mr_Inhib_table_rdoc_cov_raw_plot <- mr_Inhib_table_rdoc_cov_raw_new %>%
  mutate(measure_new = ifelse(measure=="nih", "NIH \nToolbox", 
                                     ifelse(measure=="acc", "Accuracy \n(incongruent)",
                                            ifelse(parameters=="Drift rate", "Drift \nrate",
                                            ifelse(parameters=="Boundary separation", "Boundary \nseparation", NA))))) %>%
  mutate(measure_new = factor(measure_new, levels=c("NIH \nToolbox", "Accuracy \n(incongruent)", "Drift \nrate","Boundary \nseparation")))

inh <- ggplot(mr_Inhib_table_rdoc_cov_raw_plot[c(1:3, 10:12),], aes(x=est, label=parameters, y=measure_new, color=measure_new)) +
  geom_point(position=position_dodge(width = 1), stat = "identity", size=4) +
  geom_errorbar(aes(xmin=lci, xmax=uci), width=.15,  position=position_dodge(width = 1), stat="identity", linewidth=2) +
  geom_vline(xintercept = 0) +
  labs(y="DDM model parameter", x="beta [95% CI]", title="Inhibition") +
  scale_x_continuous(breaks=seq(-0.3, 0.3, 0.3)) +
  scale_color_manual(values=group.colors) +
  facet_grid(parameters~., scales = "free", space = "fixed", labeller = as_labeller(
    c(`Boundary separation` = "Model 2", 
      `Drift rate` = "Model 1"))) +
  theme_apa() +
  theme(strip.background = element_blank(), #remove background for facet labels
        strip.text.y = element_blank(),
        panel.border = element_rect(colour = "black", fill = NA), #add black border
        panel.spacing = unit(0, "lines"), #remove space between facets)
        legend.position="none",
        text=element_text(size=30))

mr_Exec_table_rdoc_cov_raw_plot <- mr_Exec_table_rdoc_cov_raw_new %>%
  mutate(measure_new = ifelse(measure=="nih", "NIH \nToolbox", 
                                     ifelse(measure=="acc", "Accuracy \n(incongruent)",
                                            ifelse(parameters=="Drift rate", "Drift \nrate",
                                            ifelse(parameters=="Boundary separation", "Boundary \nseparation", NA))))) %>%
  mutate(measure_new = factor(measure_new, levels=c("NIH \nToolbox", "Accuracy \n(incongruent)", "Drift \nrate","Boundary \nseparation")))

ss <- ggplot(mr_Exec_table_rdoc_cov_raw_plot[c(1:3, 10:12),], aes(x=est, label=parameters, y=measure_new, color=measure_new)) +
  geom_point(position=position_dodge(width = 1), stat = "identity", size=4) +
  geom_errorbar(aes(xmin=lci, xmax=uci), width=.15,  position=position_dodge(width = 1), stat="identity", linewidth=2) +
  geom_vline(xintercept = 0) +
  labs(y="DDM model parameter", x="beta [95% CI]", title="Set-shifting") +
  scale_x_continuous(breaks=seq(-0.3, 0.3, 0.3)) +
  scale_color_manual(values=group.colors) +
  facet_grid(parameters~., scales = "free", space = "fixed", labeller = as_labeller(
    c(`Boundary separation` = "Model 2", 
      `Drift rate` = "Model 1"))) +
  theme_apa() +
  theme(strip.background = element_blank(), #remove background for facet labels
        panel.border = element_rect(colour = "black", fill = NA), #add black border
        panel.spacing = unit(0, "lines"), #remove space between facets)
        legend.position="none",
        text=element_text(size=30))

val_rdoc <- ggarrange(ern_rdoc + rremove("xylab"),
                      inh + rremove("xylab") + rremove("y.text") + rremove("y.ticks"),
          ss + rremove("xylab") + rremove("y.text") + rremove("y.ticks"),
          ncol=3, nrow=1,
          widths = c(1.5, .9, 1))
# val_rdoc <- annotate_figure(val_rdoc, left = grid::textGrob("DDM model parameter", rot = 90, vjust = 1, gp = grid::gpar(fontsize = 20)),
                # bottom = grid::textGrob("beta [95% CI]", gp = grid::gpar(fontsize=20)))
val_rdoc
ggsave(here("./../presentations/SOBP_2023/val_rdoc.png"), val_rdoc, device="png", width=17.5, height=10)
```

```{r}
rdoc_heritability_table <- read.csv("../tables/rdoc_heritability_table.csv")[,-1]
rdoc_heritability_table[c(1:4,7:8),1] <- c("Drift rate","Drift rate (congruent)","Drift rate (incongruent)","Boundary separation", "NIH Toolbox", "Raw accuracy)")

apa_table(rdoc_heritability_table[c(1:4,7:8),],
          digits=2,
          caption="Familiality of flanker task measures")
```

